# ?? ?? ?? ?? ?? (2026-01-12)

## ?? ??

**?? ?? ??, v2 ??? ?? ?? ?**
- ?? ??: Engine B
- `build_v2_diagnostics()`? v2 ?? ???? ???? ??? ??

---

## ?? ??

### Engine A (?? - ???)
**??**: ?? ?? ?? ??. v2_diagnostics? Engine B ??? ???.

### Engine B (?? - ?? ??)
**??**: `lens_signature_engine_v7/core/measure/segmentation/color_masks.py::build_color_masks_with_retry()`

**??**:
- `build_sampling_mask()` ?? (dark_top_p + chroma_top_p - ?? ??)
- 2-pass retry (k=expected, confidence ??? k=expected+1 ???)
- role ?? ??: `role_policy` ??? `legacy` (?? ? `inkness`? ??)
- `build_cluster_stats()`? compactness, alpha_like ??
- inkness_score? spatial_prior ??

---

## ?? ?? ?? ?

```
API routes
  - /inspect
      run_signature_engine.py
        analyzer.py::evaluate()
          _attach_v2_diagnostics()
            build_v2_diagnostics()
              build_color_masks_with_retry()  -> Engine B
  - /analyze_single
      single_analyzer.py::_analyze_ink_segmentation()
        build_color_masks_with_retry()  -> Engine B
```

---

## ?? ?? ??

### Phase 1: single_analyzer.py ??
**??**: `lens_signature_engine_v7/core/pipeline/single_analyzer.py`
**??**: ?? ?? API? Engine B ??

### Phase 2: color_masks.py ??
**??**: `lens_signature_engine_v7/core/measure/segmentation/color_masks.py`
**??**: ???/??/?? ?? ??, Engine B ?? ??

### Phase 3: v2_diagnostics ?? ??
**??**: `lens_signature_engine_v7/core/measure/diagnostics/v2_diagnostics.py`
**??**: build_v2_diagnostics? Engine B ??? ??

---

## ?? ?? ??

### 1. ?? ?? ??
| ?? | ?? | ?? |
|------|------|------|
| `color_masks.py` | Engine B ?? | ? ?? ?? |
| `v2_diagnostics.py` | v2 ??? ?? | ? Engine B ?? |

### 2. ?? ???
| ?? | ?? | ?? ?? | ?? |
|------|------|----------|------|
| `single_analyzer.py` | `_analyze_ink_segmentation()` | Engine B | ? ?? |
| `analyzer.py` | `evaluate_per_color()` | Engine B | ? ?? |
| `analyzer.py` | `evaluate()` | Engine B | ? ?? |
| `analyzer.py` | `evaluate_multi()` | Engine B | ? ?? |

---

## ?? ?? ??

| ?? | Engine A (??) | Engine B (??) |
|------|----------------|----------------|
| ??? | `sample_ink_candidates()` | `build_sampling_mask()` |
| k-means | ?? k | 2-pass retry |
| Role ?? | L* ?? | inkness/legacy ?? |
| Cluster Stats | ?? ?? | compactness, alpha_like ?? |
| ?? ?? | ?? ?? ?? | ?? ?? ?? |

---

## ?? ? ????

1. **?? ??? ??**: `build_v2_diagnostics()` ?? ?? analyzer.py?? ???
2. **????? ? ??**: `clusters`, `palette`, `quality`, `warnings_by_category` ? v2 ?? ??
3. **?? ??**: smoke_tests ? STD ?? API ?? ?? ??

---

## ?? ?? ??

```
Current API
  - /api/v7/inspect  -> Engine B
  - /api/v7/analyze_single  -> Engine B

Engine B = ink analysis SSoT
```

**?? ??**: ?? ?? ??, smoke_tests ??
**?? ??**: STD ?? API ?? ?? ? ?? ??? ??
