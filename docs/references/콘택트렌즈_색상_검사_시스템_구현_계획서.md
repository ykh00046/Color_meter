# 콘택트렌즈 색상 검사 시스템 상세 구현 계획서

**작성일:** 2025년 12월 10일  
**프로젝트:** 동심원 r-프로파일 기반 색상/인쇄 품질 검사 시스템 구축

---

## 1. 프로젝트 개요

### 1.1 배경 및 목적
기존의 육안 검사 및 딥러닝 기반 검사의 한계(데이터 확보 비용, 블랙박스 문제)를 극복하기 위해, 콘택트렌즈의 기하학적 특성(동심원)을 활용한 **규칙 기반(Rule-based) 머신비전 시스템**을 개발합니다.
본 시스템은 렌즈의 반지름 방향(Radial) 색상 분포를 1D 프로파일로 변환하여, 구역별(Edge, Middle, Inner) 색상 차이($\Delta E$)를 정량적으로 분석하고 OK/NG를 자동 판정합니다.

### 1.2 핵심 기술 (Radial Profile Analysis)
- **전처리:** 직교 좌표계($x, y$) 이미지를 극좌표계($r, \theta$)로 변환 (`cv2.warpPolar` 활용).
- **특징 추출:** 회전 불변성(Rotation Invariant) 확보를 위해 각 반지름 $r$에서의 평균 색상(Ring Average)을 계산하여 1차원 프로파일 생성.
- **판정:** 설계 기준 프로파일과 측정 프로파일 간의 CIEDE2000 색차 계산.

---

## 2. 시스템 아키텍처

### 2.1 기술 스택 (Tech Stack)
- **Language:** Python 3.10+
- **Core Vision:** OpenCV (`opencv-python`), NumPy
- **Signal Processing:** SciPy (Savitzky-Golay filter, Find peaks)
- **Color Science:** `skimage` or OpenCV (LAB conversion, Delta E)
- **GUI Framework:** PyQt6 (Real-time plotting & control)
- **Data Management:** JSON (Config/SKU), CSV (Logs)

### 2.2 폴더 구조 (Directory Structure)
```text
C:\X\Color_meter\
├── config/                 # 시스템 설정 및 SKU별 기준 데이터
│   ├── system_config.json  # 카메라, 조명 등 하드웨어 설정
│   └── sku_db/             # SKU별 기준 프로파일 (.json)
├── data/                   # 데이터 저장소
│   ├── raw_images/         # 테스트용 원본 이미지
│   ├── ng_images/          # 검출된 불량 이미지 아카이빙
│   └── logs/               # 검사 이력 CSV
├── src/                    # 소스 코드
│   ├── algorithms/         # 핵심 영상 처리 알고리즘
│   │   ├── lens_detector.py   # 중심(cx, cy) 및 반경(R) 검출
│   │   ├── radial_profiler.py # Polar 변환, 1D 신호 추출
│   │   ├── zone_segmenter.py  # 미분 기반 변곡점 탐지, Zone 분할
│   │   └── color_evaluator.py # ΔE 계산, OK/NG 판정 로직
│   ├── ui/                 # 사용자 인터페이스
│   │   ├── main_window.py     # 메인 윈도우 진입점
│   │   ├── plotting.py        # Matplotlib/PyQtGraph 위젯
│   │   └── settings_dlg.py    # 설정 다이얼로그
│   ├── utils/              # 유틸리티
│   │   ├── camera.py          # 카메라 제어 인터페이스
│   │   └── file_io.py         # 이미지/JSON 로드 및 저장
│   └── main.py             # 프로그램 실행 파일
├── tests/                  # 단위 테스트 (Unit Tests)
├── requirements.txt        # 의존성 패키지 목록
└── README.md               # 프로젝트 문서
```

---

## 3. 단계별 구현 로드맵 (Milestones)

### Phase 1: 핵심 알고리즘 프로토타입 (Weeks 1-2)
**목표:** 단일 이미지 입력 시 r-프로파일 그래프 출력 및 육안 검증
1. **환경 구축:** Python 가상환경 및 OpenCV, Matplotlib 설치.
2. **Lens Detection:**
   - `cv2.HoughCircles` 또는 Contour 분석을 통해 렌즈의 외곽원과 중심 좌표 정밀 검출.
3. **Radial Profiling:**
   - **Linear Polar Transform:** `cv2.warpPolar` 함수를 사용하여 원형 렌즈 이미지를 직사각형(Row: r, Col: $\theta$) 형태로 변환 (Unwrapping).
   - **Averaging:** $\theta$ 축(열 방향)으로 평균을 내어 $r$ 축에 대한 1D RGB 배열 추출.
4. **Color Space:** RGB 프로파일을 LAB 색공간으로 변환.

### Phase 2: 자동 영역 분할 및 품질 판정 (Weeks 3-4)
**목표:** Zone 자동 인식 및 수치적 품질(ΔE) 산출
1. **Signal Smoothing:** `scipy.signal.savgol_filter` 등을 적용하여 노이즈 제거.
2. **Zone Segmentation:**
   - LAB 채널 또는 ΔE 곡선의 1차/2차 미분값을 분석하여 색상이 급격히 변하는 변곡점 탐지.
   - 탐지된 지점을 기준으로 Edge(A), Mix(A-B), Middle(B), Mix(B-C), Inner(C) 영역 자동 할당.
3. **Quality Evaluation:**
   - 기준 프로파일(Golden Master)과 비교하여 각 Zone 별 평균 ΔE 및 최대 ΔE 계산.
   - CIEDE2000 수식 적용 (`skimage.color.deltaE_ciede2000`).

### Phase 3: SKU 관리 및 UI 개발 (Weeks 5-6)
**목표:** 사용자가 조작 가능한 GUI 및 다품종 대응 체계 구축
1. **SKU Manager:**
   - 양품 이미지를 등록하면 자동으로 기준 프로파일을 생성하여 JSON으로 저장하는 기능.
   - 허용 오차(Threshold) 설정 UI.
2. **Dashboard UI (PyQt6):**
   - **Live View:** 카메라 영상 또는 로드된 이미지 표시.
   - **Overlay:** 이미지 위에 검출된 Zone 경계선 및 NG 부위 표시.
   - **Graph View:** $r$축에 따른 색상 변화 그래프 실시간 렌더링.
   - **Status Panel:** OK/NG 판정 결과 및 주요 수치 표시.

### Phase 4: 시스템 통합 및 최적화 (Weeks 7-8)
**목표:** 현장 도입 수준의 안정성 확보
1. **Camera Integration:** Basler/Hikrobot 등 산업용 카메라 SDK 연동 (또는 웹캠 시뮬레이션).
2. **Optimization:** 전체 처리 속도 200ms 이내 최적화 (멀티스레딩, 연산 효율화).
3. **Reporting:** 일별/Lot별 불량률 집계 및 CSV 내보내기.

---

## 4. 하드웨어 권장 사양 (참고)

- **Camera:** 5MP 이상, Global Shutter (이동 중 촬영 시 필수).
  - 렌즈 해상력: 이미지 상 렌즈 지름이 1000px 이상 확보 권장.
- **Lens:** 왜곡(Distortion)이 적은 매크로 렌즈 또는 텔레센트릭 렌즈.
- **Lighting:**
  - 균일도 확보를 위한 **돔 조명(Dome Light)** 또는 확산판이 포함된 링 조명.
  - 색 재현성을 위해 고연색성(High CRI), 색온도 5000K~6000K 고정 LED.
- **Computing:**
  - CPU: Intel Core i5 이상 (단일 코어 성능 중요).
  - RAM: 8GB 이상.
  - GPU: 필수는 아니나, 추후 딥러닝 확장 고려 시 NVIDIA RTX 시리즈 권장.

---

## 5. 기대 효과 및 검증 전략

- **정량화:** "색이 좀 다르다"는 주관적 판단을 "Edge Zone ΔE 5.2 (Spec 3.0)"으로 객관화.
- **검증 시나리오:**
  - **Golden Sample Test:** 양품 30장 반복 측정 시 ΔE 편차가 0.5 미만이어야 함 (재현성).
  - **Defect Test:** 의도적 불량(잉크 농도 10% 감소, 도트 누락) 샘플 검출 성공률 95% 이상 목표.
