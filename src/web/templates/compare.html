<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎπÑÍµê Î∂ÑÏÑù (Compare) - Color Meter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b1020;
            --card: #151e32;
            --card-hover: #1e293b;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --border: rgba(255,255,255,0.08);
            --accent: #22d3ee;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        * { font-family: 'Manrope', sans-serif; box-sizing: border-box; }
        body { background: radial-gradient(circle at 15% 20%, #11182c, #0b1020 45%, #060912 100%); color: var(--text); }

        .card {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge { display: inline-flex; align-items: center; padding: 0.2rem 0.6rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge-neutral { background: rgba(148, 163, 184, 0.1); color: var(--muted); border: 1px solid rgba(148, 163, 184, 0.2); }

        /* Table Styles */
        .metrics-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .metrics-table th { text-align: left; padding: 0.5rem; color: var(--muted); font-weight: 500; border-bottom: 1px solid var(--border); }
        .metrics-table td { padding: 0.5rem; border-bottom: 1px solid var(--border); }
        .metrics-table tr:last-child td { border-bottom: none; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Layout Utilities */
        .grid-dashboard {
            display: grid;
            grid-template-columns: 320px 1fr 300px; /* Visuals | Main Analysis | Quality & Action */
            gap: 1.5rem;
            align-items: start;
        }
        @media (max-width: 1280px) {
            .grid-dashboard { grid-template-columns: 1fr 1fr; }
            .col-span-full-mobile { grid-column: 1 / -1; }
        }
        @media (max-width: 1024px) {
            .grid-dashboard { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="p-6 min-h-screen">
    <div class="max-w-[1600px] mx-auto space-y-6">

        <!-- Top Navigation & Title -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-4 border-b border-gray-800">
            <div>
                <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                    <span class="text-cyan-400">ÎπÑÍµê Î∂ÑÏÑù</span>
                    <span class="text-gray-500 text-lg font-medium">/ STD vs Sample</span>
                </h1>
                <p class="text-sm text-gray-400 mt-1">Í∏∞Ï§Ä Ïù¥ÎØ∏ÏßÄ ÎåÄÎπÑ ÏÉòÌîåÏùò ÏÉâÏ∞®, ÏûâÌÅ¨ ÌäπÏÑ±, ÌíàÏßà Î≥ÄÌôîÎ•º Ï†ïÎ∞Ä Î∂ÑÏÑùÌï©ÎãàÎã§.</p>
            </div>
            <div class="flex gap-2">
                <a href="/" class="px-4 py-2 rounded-lg bg-slate-800 text-gray-300 hover:bg-slate-700 text-sm font-medium transition">Home</a>
                <a href="/history" class="px-4 py-2 rounded-lg bg-slate-800 text-gray-300 hover:bg-slate-700 text-sm font-medium transition">History</a>
            </div>
        </header>

        <!-- Input Area (Compact) -->
        <section class="card p-4 flex flex-col md:flex-row gap-4 items-end bg-slate-900/50">
            <div class="flex-1 w-full">
                <label class="block text-xs font-semibold text-gray-400 mb-2 uppercase">Reference (STD)</label>
                <input type="file" id="stdFile" accept="image/*" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-cyan-500/10 file:text-cyan-400 hover:file:bg-cyan-500/20 transition cursor-pointer">
            </div>
            <div class="flex-1 w-full">
                <label class="block text-xs font-semibold text-gray-400 mb-2 uppercase">Target (Sample)</label>
                <input type="file" id="sampleFile" accept="image/*" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-500/10 file:text-indigo-400 hover:file:bg-indigo-500/20 transition cursor-pointer">
            </div>
            <div class="w-full md:w-44">
                <label class="block text-xs font-semibold text-gray-400 mb-2 uppercase">SKU</label>
                <select id="skuSelect" class="w-full rounded-lg bg-slate-800 border border-gray-700 text-sm text-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500/50">
                    <option value="SKU_INK1">SKU_INK1</option>
                    <option value="SKU_INK2">SKU_INK2</option>
                    <option value="SKU_INK3">SKU_INK3</option>
                </select>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button id="btnCompare" class="w-full md:w-auto px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold shadow-lg shadow-cyan-500/20 transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    Î∂ÑÏÑù Ïã§Ìñâ
                </button>
                <button id="btnDownload" class="px-4 py-2 bg-slate-800 text-gray-300 rounded-lg text-sm font-semibold border border-gray-700 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                    JSON Ï†ÄÏû•
                </button>
            </div>
        </section>

        <!-- Main Dashboard (Hidden initially) -->
        <main id="dashboard" class="hidden space-y-6">

            <!-- 1. Judgment Banner -->
            <div id="judgment-banner" class="card p-5 flex flex-col md:flex-row items-center justify-between gap-6 border-l-4">
                <div class="flex items-center gap-6">
                    <div id="judgment-badge" class="text-3xl font-black px-6 py-3 rounded-xl bg-gray-800 tracking-wider">
                        -
                    </div>
                    <div>
                        <div class="text-sm text-gray-400 uppercase font-semibold tracking-wide mb-1">Overall Assessment</div>
                        <div id="judgment-reason" class="text-lg text-gray-200 font-medium">-</div>
                    </div>
                </div>
                <div class="flex gap-8 text-right">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Max Delta E</div>
                        <div id="header-max-de" class="text-2xl font-bold text-white">-</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Shift Direction</div>
                        <div id="header-shift" class="text-sm font-medium text-cyan-400 max-w-[200px] leading-tight">-</div>
                    </div>
                </div>
            </div>

            <!-- 1.5 Cluster Summary -->
            <section id="cluster-summary" class="card p-4 hidden">
                <div class="section-title">
                    <svg class="w-4 h-4 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Cluster Diagnostics
                </div>
                <div id="cluster-summary-body" class="space-y-3 text-sm text-gray-300"></div>
            </section>

            <!-- 2. Content Grid -->
            <div class="grid-dashboard">

                <!-- Left Col: Visuals -->
                <div class="space-y-4">
                    <div class="card p-4">
                        <div class="section-title flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                Visual Comparison
                            </div>
                            <div class="flex gap-1">
                                <button id="btnBlink" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-gray-300 px-2 py-1 rounded border border-gray-700 transition flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                    Blink
                                </button>
                                <button id="btnDownloadOverlay" class="hidden text-[10px] bg-slate-800 hover:bg-slate-700 text-gray-300 px-2 py-1 rounded border border-gray-700 transition flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                    Overlay
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Standard</span>
                                <img id="img-std" class="w-full h-32 object-cover rounded border border-gray-700 bg-gray-900">
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Sample</span>
                                <img id="img-sample" class="w-full h-32 object-cover rounded border border-gray-700 bg-gray-900">
                            </div>
                        </div>
                    </div>

                    <!-- P1-2: Radial Profile Analysis Card -->
                    <div class="card p-4">
                        <div class="section-title flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                                Structural Similarity
                            </div>
                            <div id="profile-score-badge" class="text-xs font-bold px-2 py-0.5 rounded-full bg-slate-800 text-cyan-400 border border-cyan-500/30">-</div>
                        </div>
                        <div class="h-40 relative">
                            <canvas id="profile-chart"></canvas>
                        </div>
                        <div id="profile-message" class="text-[10px] text-gray-500 mt-2 italic leading-tight text-center">-</div>
                    </div>

                    <div class="card p-4">
                        <div class="section-title"><svg class="w-4 h-4 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg> Zone Deviation (Heatmap)</div>
                        <div class="relative h-48 bg-slate-900 rounded border border-gray-700 flex items-center justify-center overflow-hidden">
                            <canvas id="heatmap-canvas" class="w-full h-full"></canvas>
                            <div id="heatmap-placeholder" class="absolute text-gray-500 text-xs">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>
                        </div>
                    </div>
                </div>

                <!-- Center Col: Ink Analysis -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-lg text-white">Ink & Color Analysis</h3>
                        <div id="ink-tabs" class="flex gap-2">
                            <!-- Tabs generated by JS -->
                        </div>
                    </div>

                    <div id="ink-container" class="space-y-4">
                        <!-- Ink cards generated by JS -->
                        <div class="card p-8 text-center text-gray-500">Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</div>
                    </div>
                </div>

                <!-- Right Col: Quality & Action -->
                <div class="space-y-4 col-span-full-mobile">

                    <!-- Quality Metrics -->
                    <div class="card p-4">
                        <div class="section-title"><svg class="w-4 h-4 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Quality Metrics</div>
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>STD</th>
                                    <th>Sample</th>
                                    <th>Diff</th>
                                </tr>
                            </thead>
                            <tbody id="quality-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Action Guide -->
                    <div class="card p-4 h-full border-l-4 border-l-yellow-500/50">
                        <div class="section-title"><svg class="w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg> Action Guide</div>
                        <div id="action-guide-container" class="space-y-3 mt-3">
                            <!-- Categorized warnings by JS -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- 3. Detail Data Table -->
            <div class="card p-5">
                <div class="section-title flex justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Detailed Zone Analysis
                    </div>
                    <div class="text-xs text-gray-500 font-normal normal-case">
                        * ŒîE > 8.0 indicates significant deviation
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-400 uppercase bg-slate-800/50 border-b border-gray-700">
                            <tr>
                                <th class="px-4 py-3">Zone</th>
                                <th class="px-4 py-3">Ink Type</th>
                                <th class="px-4 py-3 text-right">ŒîL (Lightness)</th>
                                <th class="px-4 py-3 text-right">Œîa (Red-Green)</th>
                                <th class="px-4 py-3 text-right">Œîb (Yellow-Blue)</th>
                                <th class="px-4 py-3 text-right">ŒîE (Total)</th>
                                <th class="px-4 py-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="zone-table-body" class="divide-y divide-gray-800">
                            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

    </div>

    <script>
        /**
         * Frontend Adapter Logic
         * - Î∞±ÏóîÎìú ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÑÍπåÏßÄ JSÏóêÏÑú ÌåêÎã® Î°úÏßÅ(OK/NG) Î∞è Î∂ÑÎ•ò Î°úÏßÅÏùÑ ÏàòÌñâÌï©ÎãàÎã§.
         * - Ï∂îÌõÑ Î∞±ÏóîÎìú APIÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎ©¥ Ïù¥ Î°úÏßÅÏùÄ Î∞±ÏóîÎìú Îç∞Ïù¥ÌÑ∞ Ïö∞ÏÑ†ÏúºÎ°ú Î≥ÄÍ≤ΩÎê©ÎãàÎã§.
         */

        const UI = {
            els: {
                btnCompare: document.getElementById('btnCompare'),
                btnDownload: document.getElementById('btnDownload'),
                btnDownloadOverlay: document.getElementById('btnDownloadOverlay'),
                btnBlink: document.getElementById('btnBlink'),
                dashboard: document.getElementById('dashboard'),
                stdFile: document.getElementById('stdFile'),
                sampleFile: document.getElementById('sampleFile'),
                imgStd: document.getElementById('img-std'),
                imgSample: document.getElementById('img-sample'),
            },

            init() {
                this.els.btnCompare.addEventListener('click', this.handleCompare.bind(this));
                this.els.btnDownload.addEventListener('click', this.handleDownload.bind(this));
                if(this.els.btnDownloadOverlay) this.els.btnDownloadOverlay.addEventListener('click', this.handleDownloadOverlay.bind(this));
                if(this.els.btnBlink) this.els.btnBlink.addEventListener('click', this.handleBlink.bind(this));
            },

            async handleCompare() {
                const std = this.els.stdFile.files[0];
                const sample = this.els.sampleFile.files[0];
                if (!std || !sample) return alert('Í∏∞Ï§Ä(STD) Ïù¥ÎØ∏ÏßÄÏôÄ ÏÉòÌîå Ïù¥ÎØ∏ÏßÄÎ•º Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');

                this.setLoading(true);
                try {
                    const result = await API.compare(std, sample);
                    if (!result?.tests || result.tests.length === 0) {
                        alert('Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§. ÏûÖÎ†• Ïù¥ÎØ∏ÏßÄÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }
                    this.render(result, std, sample);
                    this.lastResult = result;
                    this.els.btnDownload.disabled = false;

                    // Show overlay download button if overlay path exists
                    const overlayPath = result.tests?.[0]?.overlay;
                    if (overlayPath && this.els.btnDownloadOverlay) {
                        this.els.btnDownloadOverlay.classList.remove('hidden');
                    }
                } catch (e) {
                    console.error(e);
                    const message = e?.message || (typeof e === 'string' ? e : JSON.stringify(e));
                    alert('Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + message);
                } finally {
                    this.setLoading(false);
                }
            },

            handleBlink() {
                if (this.blinkInterval) {
                    clearInterval(this.blinkInterval);
                    this.blinkInterval = null;
                    this.els.btnBlink.classList.remove('bg-cyan-600', 'text-white');
                    this.els.btnBlink.classList.add('bg-slate-800', 'text-gray-300');
                    this.els.imgSample.src = this.originalSampleSrc || this.els.imgSample.src;
                    return;
                }

                this.els.btnBlink.classList.remove('bg-slate-800', 'text-gray-300');
                this.els.btnBlink.classList.add('bg-cyan-600', 'text-white');

                // Save original source
                this.originalSampleSrc = this.els.imgSample.src;
                const stdSrc = this.els.imgStd.src;

                let showStd = false;
                this.blinkInterval = setInterval(() => {
                    showStd = !showStd;
                    this.els.imgSample.src = showStd ? stdSrc : this.originalSampleSrc;
                }, 600);
            },

            handleDownloadOverlay() {
                const overlayPath = this.lastResult?.tests?.[0]?.overlay;
                if (!overlayPath) return alert('Ïò§Î≤ÑÎ†àÏù¥ Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');

                const a = document.createElement('a');
                a.href = overlayPath;
                a.download = `overlay_${new Date().getTime()}.png`;
                a.click();
            },

            handleDownload() {
                if (!this.lastResult) return;
                const blob = new Blob([JSON.stringify(this.lastResult, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
                a.click();
            },

            setLoading(isLoading) {
                const btn = this.els.btnCompare;
                if (isLoading) {
                    btn.disabled = true;
                    btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Î∂ÑÏÑù Ï§ë...`;
                } else {
                    btn.disabled = false;
                    btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg> Î∂ÑÏÑù Ïã§Ìñâ`;
                }
            },

            render(data, stdFile, sampleFile) {
                this.els.dashboard.classList.remove('hidden');

                // 0. Prepare Data (Adapter Step)
                const test = data.tests[0]; // Assuming single test for now
                const ref = data.reference;
                const judgment = Logic.determineJudgment(test, data);
                const warnings = Logic.categorizeWarnings(data);

                // 1. Visuals
                this.els.imgStd.src = URL.createObjectURL(stdFile);
                this.els.imgSample.src = URL.createObjectURL(sampleFile);
                this.originalSampleSrc = this.els.imgSample.src; // Cache for blink
                ChartRenderer.drawHeatmap(test.zone_deltas);

                // P1-2: Radial Profile Chart
                if (test.radial_profile && data.reference?.radial_profile) {
                    ChartRenderer.drawProfileChart(data.reference.radial_profile, test.radial_profile);

                    const pScore = test.profile_score || 0;
                    const pDetails = test.profile_details || {};
                    const badge = document.getElementById('profile-score-badge');
                    badge.textContent = `Score: ${pScore.toFixed(1)}`;
                    badge.className = `text-xs font-bold px-2 py-0.5 rounded-full border ${pScore > 80 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/30' : 'bg-amber-500/10 text-amber-400 border-amber-500/30'}`;

                    document.getElementById('profile-message').textContent = pDetails.message || 'Structural comparison complete';
                } else {
                    document.getElementById('profile-message').textContent = 'Profile data unavailable';
                }

                // 2. Judgment Banner
                const banner = document.getElementById('judgment-banner');
                const badge = document.getElementById('judgment-badge');

                if (judgment.status === 'OK') {
                    banner.className = 'card p-5 flex flex-col md:flex-row items-center justify-between gap-6 border-l-4 border-l-emerald-500';
                    badge.className = 'text-3xl font-black px-6 py-3 rounded-xl bg-emerald-500/10 text-emerald-500 tracking-wider';
                    badge.textContent = 'PASS';
                    document.getElementById('judgment-reason').innerHTML = '<span class="text-emerald-400">?? ???? ?? ?? ?? ????.</span>';
                } else if (judgment.status === 'WARN') {
                    banner.className = 'card p-5 flex flex-col md:flex-row items-center justify-between gap-6 border-l-4 border-l-amber-500';
                    badge.className = 'text-3xl font-black px-6 py-3 rounded-xl bg-amber-500/10 text-amber-500 tracking-wider';
                    badge.textContent = 'WARN';
                    document.getElementById('judgment-reason').innerHTML = `<span class="text-amber-400">${judgment.primaryReason}</span>`;
                } else {
                    banner.className = 'card p-5 flex flex-col md:flex-row items-center justify-between gap-6 border-l-4 border-l-rose-500';
                    badge.className = 'text-3xl font-black px-6 py-3 rounded-xl bg-rose-500/10 text-rose-500 tracking-wider';
                    badge.textContent = judgment.status === 'STOP' ? 'STOP' : 'FAIL';
                    document.getElementById('judgment-reason').innerHTML = `<span class="text-rose-400">${judgment.primaryReason}</span>`;
                }

const clusterMax = Logic.getClusterMaxDelta(test);
                const headerMax = clusterMax ?? test.max_delta_e;
                document.getElementById('header-max-de').textContent = headerMax.toFixed(2);
                document.getElementById('header-max-de').className = headerMax > 8.0 ? 'text-2xl font-bold text-rose-400' : 'text-2xl font-bold text-emerald-400';
                document.getElementById('header-shift').textContent = test.overall_shift || 'No significant shift';

                // 1.5 Cluster Summary
                this.renderClusterSummary(test);

                // 3. Ink Analysis
                const container = document.getElementById('ink-container');
                container.innerHTML = '';

                // Ink Names: use explicit keys or fallback
                const inkNames = test.ink_deltas ? Object.keys(test.ink_deltas) : ['All Zones'];

                inkNames.forEach(ink => {
                    const metrics = test.ink_deltas ? test.ink_deltas[ink] : null;
                    if (!metrics) return;

                    const html = `
                        <div class="card p-4 border border-slate-700/50 hover:border-slate-600 transition">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                        <span class="w-3 h-3 rounded-full bg-cyan-500"></span> ${ink.toUpperCase()}
                                    </h4>
                                    <p class="text-xs text-gray-400 mt-1">Zones: ${metrics.zones.join(', ')}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold ${metrics.mean_delta_e > 8.0 ? 'text-rose-400' : 'text-emerald-400'}">${metrics.mean_delta_e.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500">Mean ŒîE</div>
                                </div>
                            </div>

                            <!-- Lab Bars -->
                            <div class="space-y-3 bg-slate-900/50 p-3 rounded-lg">
                                ${this.renderBar('Lightness (L)', metrics.mean_delta_L, -5, 5, 'Darker', 'Brighter')}
                                ${this.renderBar('Red-Green (a)', metrics.mean_delta_a, -5, 5, 'Greener', 'Redder')}
                                ${this.renderBar('Yellow-Blue (b)', metrics.mean_delta_b, -5, 5, 'Bluer', 'Yellower')}
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });

                // 4. Quality Table
                const tbody = document.getElementById('quality-table-body');
                tbody.innerHTML = '';

                const addRow = (label, refVal, testVal, diff, isGood) => {
                    const diffClass = isGood ? 'text-emerald-400' : 'text-rose-400 font-bold';
                    tbody.innerHTML += `
                        <tr>
                            <td>${label}</td>
                            <td class="text-gray-400">${refVal}</td>
                            <td class="text-white">${testVal}</td>
                            <td class="${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                        </tr>
                    `;
                };

                // Blur
                const bRef = ref.metrics?.blur?.score?.toFixed(1) || '-';
                const bTest = test.metrics?.blur?.score?.toFixed(1) || '-';
                const bDiff = test.comparison?.blur_delta?.toFixed(1) || '0.0';
                addRow('Sharpness (Blur)', bRef, bTest, bDiff, Number(bDiff) > -50);

                // Dot Count
                const dRef = ref.metrics?.dot_stats?.dot_count || '-';
                const dTest = test.metrics?.dot_stats?.dot_count || '-';
                const dDiff = test.comparison?.dot_delta?.dot_count || '0';
                addRow('Dot Count', dRef, dTest, dDiff, Math.abs(dDiff) < 100);

                // Dot Coverage
                const cRef = (ref.metrics?.dot_stats?.dot_coverage * 100).toFixed(1) + '%' || '-';
                const cTest = (test.metrics?.dot_stats?.dot_coverage * 100).toFixed(1) + '%' || '-';
                const cDiffVal = (test.comparison?.dot_delta?.dot_coverage * 100);
                const cDiff = cDiffVal ? cDiffVal.toFixed(1) + '%' : '0%';
                addRow('Ink Coverage', cRef, cTest, cDiff, Math.abs(cDiffVal) < 5);

                // 5. Action Guide (Categorized)
                const guideContainer = document.getElementById('action-guide-container');
                guideContainer.innerHTML = '';

                const renderSection = (title, items, icon) => {
                    if (!items || items.length === 0) return;
                    const html = `
                        <div class="mb-3">
                            <h5 class="text-xs font-bold text-gray-400 uppercase mb-2 flex items-center gap-1">${icon} ${title}</h5>
                            <ul class="space-y-1">
                                ${items.map(msg => `<li class="text-sm text-gray-300 pl-2 border-l-2 border-slate-700">${msg}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    guideContainer.innerHTML += html;
                };

                renderSection('Process (Ink)', warnings.process, 'üîß');
                renderSection('Quality (Print)', warnings.quality, 'üëÅÔ∏è');

                if (warnings.process.length === 0 && warnings.quality.length === 0) {
                    guideContainer.innerHTML = '<div class="text-sm text-emerald-400 flex items-center gap-2">‚ú® ÌäπÏù¥ÏÇ¨Ìï≠ ÏóÜÏùå (Good Condition)</div>';
                }

                // 6. Detailed Zone Table
                const zoneTbody = document.getElementById('zone-table-body');
                zoneTbody.innerHTML = '';

                // Helper to resolve ink mapping
                const getInk = (zoneName) => {
                    if (!data.ink_mapping) return 'Unknown';
                    return data.ink_mapping[zoneName] || 'Unknown';
                };

                (test.zone_deltas || []).forEach(z => {
                    const isHighRisk = z.delta_e > 8.0;
                    const isWarn = z.delta_e > 4.0;

                    let statusBadge = '<span class="badge badge-success">OK</span>';
                    if (isHighRisk) statusBadge = '<span class="badge badge-danger">FAIL</span>';
                    else if (isWarn) statusBadge = '<span class="badge badge-warning">WARN</span>';

                    const rowClass = isHighRisk ? 'bg-rose-500/5' : '';

                    zoneTbody.innerHTML += `
                        <tr class="${rowClass} hover:bg-slate-800/50 transition">
                            <td class="px-4 py-3 font-medium text-white">${z.zone}</td>
                            <td class="px-4 py-3 text-gray-400 text-xs uppercase tracking-wide">${getInk(z.zone)}</td>
                            <td class="px-4 py-3 text-right text-gray-300">${z.delta_L.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right text-gray-300">${z.delta_a.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right text-gray-300">${z.delta_b.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right font-bold ${isHighRisk ? 'text-rose-400' : 'text-white'}">${z.delta_e.toFixed(2)}</td>
                            <td class="px-4 py-3 text-center">${statusBadge}</td>
                        </tr>
                    `;
                });
            },

            renderClusterSummary(test) {
                const wrap = document.getElementById('cluster-summary');
                const body = document.getElementById('cluster-summary-body');
                if (!wrap || !body) return;

                const clusters = test.cluster_results?.clusters || [];
                const matches = test.cluster_match || [];
                const flags = test.diagnostic_flags || [];

                if (!clusters.length && !matches.length && !flags.length) {
                    wrap.classList.add('hidden');
                    body.innerHTML = '';
                    return;
                }

                wrap.classList.remove('hidden');
                const lines = [];

                if (test.alignment && test.alignment.status !== 'ok') {
                    lines.push(`<div><strong>Alignment:</strong> ${test.alignment.status}</div>`);
                }
                if (test.sample_outside_std_ratio !== null && test.sample_outside_std_ratio !== undefined) {
                    lines.push(`<div><strong>STD Î∞ñ ÏûâÌÅ¨ ÎπÑÏú®:</strong> ${(test.sample_outside_std_ratio * 100).toFixed(2)}%</div>`);
                }

                if (clusters.length) {
                    const clusterRows = clusters.map(c => {
                        const role = c.role ? c.role : '-';
                        const coverage = ((c.coverage || 0) * 100).toFixed(1);
                        return `<li>Cluster ${c.cluster_id} ¬∑ role ${role} ¬∑ coverage ${coverage}%</li>`;
                    }).join('');
                    lines.push(`<div><strong>Cluster</strong><ul class="list-disc list-inside">${clusterRows}</ul></div>`);
                }

                if (matches.length) {
                    const matchRows = matches.map(m => {
                        const role = m.ref_role || '-';
                        const stdId = m.ref_std_id || '-';
                        return `<li>${stdId} (${role}) ‚Üí T${m.test_cluster_id} ¬∑ ŒîE ${m.delta_e.toFixed(2)}</li>`;
                    }).join('');
                    lines.push(`<div><strong>Matching</strong><ul class="list-disc list-inside">${matchRows}</ul></div>`);
                }

                if (test.match_confidence !== null && test.match_confidence !== undefined) {
                    lines.push(`<div><strong>Match confidence:</strong> ${test.match_confidence.toFixed(2)}</div>`);
                }

                if (flags.length) {
                    const flagRows = flags.map(f => `<li>${f}</li>`).join('');
                    lines.push(`<div><strong>Diagnostic flags</strong><ul class="list-disc list-inside">${flagRows}</ul></div>`);
                }

                body.innerHTML = lines.join('');
            },

            renderBar(label, value, min, max, lowLabel, highLabel) {
                // Normalize value to 0-100 range
                const range = max - min;
                const percent = Math.min(Math.max(((value - min) / range) * 100, 0), 100);
                const color = Math.abs(value) > 1.5 ? 'bg-amber-500' : 'bg-slate-500';

                return `
                    <div class="text-xs">
                        <div class="flex justify-between text-gray-400 mb-1">
                            <span>${lowLabel}</span>
                            <span class="text-white font-mono">${label} (${value > 0 ? '+' : ''}${value.toFixed(2)})</span>
                            <span>${highLabel}</span>
                        </div>
                        <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden relative">
                            <div class="absolute top-0 bottom-0 w-0.5 bg-white/30 left-1/2 z-10"></div>
                            <div class="h-full ${color} transition-all duration-500" style="width: ${Math.abs((value/5)*50)}%; left: ${value < 0 ? 50 - Math.abs((value/5)*50) : 50}%"></div>
                        </div>
                    </div>
                `;
            }
        };

        const Logic = {
            determineJudgment(test, data) {
                if (test.decision_blocked) {
                    const reason = (test.decision_block_reasons || []).join(', ');
                    return { status: 'WARN', isOk: false, primaryReason: `?? ?? (${reason || 'gated'})` };
                }

                if (test.alignment?.status === 'stop') {
                    return { status: 'WARN', isOk: false, primaryReason: 'Alignment stop (?? ??)' };
                }

                const decision = data?.decision_policy;
                const matches = test.cluster_match || [];
                if (decision && matches.length) {
                    let status = 'OK';
                    let reason = '';

                    matches.forEach((m) => {
                        const role = (m.ref_role || '').toLowerCase();
                        const policy = decision[role] || null;
                        if (!policy) return;

                        if (role === 'primary') {
                            if (m.delta_e > policy.warn) {
                                status = 'NG';
                                reason = `Primary ?E ${m.delta_e.toFixed(2)} > ${policy.warn}`;
                            } else if (m.delta_e > policy.ok && status === 'OK') {
                                status = 'WARN';
                                reason = `Primary ?E ${m.delta_e.toFixed(2)} > ${policy.ok}`;
                            }
                        } else {
                            if (m.delta_e > policy.warn && status === 'OK') {
                                status = 'WARN';
                                reason = `${role} ?E ${m.delta_e.toFixed(2)} > ${policy.warn}`;
                            }
                        }
                    });

                    return { status, isOk: status === 'OK', primaryReason: reason };
                }

                if (test.judgment && test.judgment !== 'N/A') {
                    return {
                        status: test.judgment === 'OK' ? 'OK' : 'NG',
                        isOk: test.judgment === 'OK',
                        primaryReason: test.ng_reasons?.[0] || 'Unknown issue'
                    };
                }

                return { status: 'WARN', isOk: false, primaryReason: 'Cluster data unavailable (diagnostic only)' };
            },

            getClusterMaxDelta(test) {
                const matches = test.cluster_match || [];
                if (!matches.length) return null;
                return Math.max(...matches.map(m => m.delta_e));
            },

            categorizeWarnings(data) {
                if (data.tests[0].categorized_warnings) return data.tests[0].categorized_warnings;

                const warnings = { process: [], quality: [] };
                const test = data.tests[0];
                const thresholds = data.quality_thresholds || {};

                const inkDeltas = test.ink_deltas || {};
                Object.keys(inkDeltas).forEach(ink => {
                    const m = inkDeltas[ink];
                    if (m.mean_delta_a > 1.5) warnings.process.push(`${ink}: Red Í≥ºÎã§ ‚Üí ÏûâÌÅ¨ ÎÜçÎèÑ ÌôïÏù∏`);
                    if (m.mean_delta_a < -1.5) warnings.process.push(`${ink}: Green Í≥ºÎã§ ‚Üí ÏûâÌÅ¨ Ï°∞Í±¥ ÌôïÏù∏`);
                    if (m.mean_delta_b > 1.5) warnings.process.push(`${ink}: Yellow Í≥ºÎã§ ‚Üí Ï°∞ÏÉâ ÎπÑÏú® Ïû¨Í≤Ä`);
                    if (m.mean_delta_b < -1.5) warnings.process.push(`${ink}: Blue Í≥ºÎã§ ‚Üí Ï°∞ÏÉâ ÎπÑÏú® Ïû¨Í≤Ä`);
                    if (Math.abs(m.mean_delta_L) > 2.0) warnings.process.push(`${ink}: Î™ÖÎèÑ(${m.mean_delta_L > 0 ? 'Î∞ùÏùå' : 'Ïñ¥ÎëêÏõÄ'}) Ìé∏Ï∞®`);
                });

                const comp = test.comparison || {};
                if (comp.blur_delta < (thresholds.blur?.delta_warn || -50)) {
                    warnings.quality.push(`Ï¥àÏ†ê Ìé∏Ï∞®(${comp.blur_delta.toFixed(0)}) ‚Üí Ï¥¨ÏòÅ/Ïù∏ÏáÑ ÌôïÏù∏`);
                }
                if (comp.dot_delta?.dot_coverage && Math.abs(comp.dot_delta.dot_coverage) > 0.05) {
                    warnings.quality.push(`ÎèÑÌä∏ Ïª§Î≤ÑÎ¶¨ÏßÄ Î≥ÄÌôî(${(comp.dot_delta.dot_coverage*100).toFixed(1)}%) ‚Üí Ïù∏ÏáÑ Í∑†ÏùºÎèÑ Ï†êÍ≤Ä`);
                }

                return warnings;
            }
        };

        const API = {
            async compare(stdFile, sampleFile) {
                const fd = new FormData();
                fd.append('reference_file', stdFile);
                fd.append('test_files', sampleFile);
                const sku = document.getElementById('skuSelect')?.value || 'SKU001';
                fd.append('sku', sku);
                const res = await fetch('/compare', { method: 'POST', body: fd });
                if (!res.ok) throw new Error(await res.text());
                return await res.json();
            }
        };

        const ChartRenderer = {
            drawHeatmap(zoneDeltas) {
                const canvas = document.getElementById('heatmap-canvas');
                if (!canvas || !zoneDeltas || !zoneDeltas.length) {
                    document.getElementById('heatmap-placeholder').style.display = 'block';
                    return;
                }
                document.getElementById('heatmap-placeholder').style.display = 'none';

                const ctx = canvas.getContext('2d');
                const w = canvas.parentElement.clientWidth;
                const h = canvas.parentElement.clientHeight;
                canvas.width = w;
                canvas.height = h;

                const maxVal = Math.max(...zoneDeltas.map(z => z.delta_e), 5);
                const barW = (w - 40) / zoneDeltas.length;

                zoneDeltas.forEach((z, i) => {
                    const hBar = (z.delta_e / maxVal) * (h - 40);
                    const x = 20 + i * barW;
                    const y = h - 20 - hBar;

                    let color = '#10b981';
                    if (z.delta_e > 4) color = '#f59e0b';
                    if (z.delta_e > 8) color = '#ef4444';

                    ctx.fillStyle = color;
                    ctx.fillRect(x + 5, y, barW - 10, hBar);

                    ctx.fillStyle = '#94a3b8';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(z.zone, x + barW / 2, h - 5);

                    ctx.fillStyle = '#fff';
                    ctx.fillText(z.delta_e.toFixed(1), x + barW / 2, y - 5);
                });
            },

            drawProfileChart(refProfile, testProfile) {
                const canvas = document.getElementById('profile-chart');
                if (!canvas) return;

                // Destroy existing chart if it exists
                if (this.profileChart) {
                    this.profileChart.destroy();
                }

                const ctx = canvas.getContext('2d');

                // Use 'a' channel for structural visualization as it's often most sensitive to color structure
                const labels = Array.from({length: refProfile.a.length}, (_, i) => i);

                this.profileChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Standard (a*)',
                                data: refProfile.a,
                                borderColor: 'rgba(148, 163, 184, 0.8)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Sample (a*)',
                                data: testProfile.a,
                                borderColor: '#22d3ee',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 10,
                                    font: { size: 9 },
                                    color: '#94a3b8'
                                }
                            },
                            tooltip: { enabled: true }
                        },
                        scales: {
                            x: { display: false },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { font: { size: 8 }, color: '#64748b' }
                            }
                        }
                    }
                });
            }
        };

        UI.init();
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled rejection:', event.reason);
            const message = event.reason?.message || (typeof event.reason === 'string' ? event.reason : JSON.stringify(event.reason));
            alert('?? ??: ' + message);
        });
    </script>
</body>
</html>
