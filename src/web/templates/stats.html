<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspection Stats - Color Meter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap');
        * { font-family: 'Manrope', sans-serif; }
        body { background: radial-gradient(circle at 10% 20%, #0f172a 0%, #0b1020 40%, #0a0c16 100%); min-height: 100vh; }
        .card { background: #0f172a; border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
        .title { color: #e2e8f0; }
        .text-sub { color: #94a3b8; }
    </style>
</head>
<body class="p-6 text-gray-100">
    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold title flex items-center gap-2">
                    <i class="fas fa-chart-line text-cyan-400"></i>
                    Inspection Statistics
                </h1>
                <p class="text-sub">Quality trends, pass rates, and RETAKE insights at a glance.</p>
            </div>
            <div class="flex gap-2">
                <a href="/" class="px-4 py-2 rounded-lg bg-slate-800 text-gray-100 font-semibold hover:bg-slate-700 transition border border-slate-700">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <a href="/compare" class="px-4 py-2 rounded-lg bg-slate-800 text-gray-100 font-semibold hover:bg-slate-700 transition border border-slate-700">
                    <i class="fas fa-balance-scale mr-2"></i>Compare
                </a>
                <a href="/history" class="px-4 py-2 rounded-lg bg-slate-800 text-gray-100 font-semibold hover:bg-slate-700 transition border border-slate-700">
                    <i class="fas fa-database mr-2"></i>History
                </a>
                <a href="/stats" class="px-4 py-2 rounded-lg bg-cyan-500 text-white font-semibold hover:bg-cyan-600 transition">
                    <i class="fas fa-chart-pie mr-2"></i>Stats
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="card p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm text-sub mb-2">SKU Code</label>
                    <input id="filter-sku" type="text" placeholder="e.g., SKU001" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-gray-100 focus:ring-2 focus:ring-cyan-500">
                </div>
                <div>
                    <label class="block text-sm text-sub mb-2">Start Date</label>
                    <input id="filter-start" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-gray-100 focus:ring-2 focus:ring-cyan-500">
                </div>
                <div>
                    <label class="block text-sm text-sub mb-2">End Date</label>
                    <input id="filter-end" type="date" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-gray-100 focus:ring-2 focus:ring-cyan-500">
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="applyFilters()" class="flex-1 px-4 py-2 rounded-lg bg-cyan-500 text-white font-semibold hover:bg-cyan-600 transition">
                        <i class="fas fa-filter mr-2"></i>Apply
                    </button>
                    <button onclick="resetFilters()" class="px-4 py-2 rounded-lg bg-slate-800 text-sub hover:bg-slate-700 transition">
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card p-5">
                <p class="text-sub text-sm">Total Inspections</p>
                <p class="text-3xl font-bold mt-1" id="stat-total">-</p>
                <p class="text-xs text-sub mt-1" id="stat-range"></p>
            </div>
            <div class="card p-5">
                <p class="text-sub text-sm">Pass Rate</p>
                <p class="text-3xl font-bold text-emerald-300 mt-1" id="stat-pass-rate">-</p>
                <p class="text-xs text-sub mt-1">OK + OK_WITH_WARNING</p>
            </div>
            <div class="card p-5">
                <p class="text-sub text-sm">Avg ΔE</p>
                <p class="text-3xl font-bold mt-1" id="stat-avg-delta-e">-</p>
                <p class="text-xs text-sub mt-1">Overall color difference</p>
            </div>
            <div class="card p-5">
                <p class="text-sub text-sm">Avg Confidence</p>
                <p class="text-3xl font-bold mt-1" id="stat-avg-confidence">-</p>
                <p class="text-xs text-sub mt-1">Inspection confidence</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="card p-5">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-lg text-gray-100">OK/NG/RETAKE</h3>
                    <span class="text-xs text-sub">Last 30 days</span>
                </div>
                <canvas id="chart-judgment"></canvas>
            </div>
            <div class="card p-5">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-lg text-gray-100">RETAKE Reasons</h3>
                    <span class="text-xs text-sub">Last 30 days</span>
                </div>
                <canvas id="chart-retake"></canvas>
            </div>
            <div class="card p-5 lg:col-span-1">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-lg text-gray-100">Daily Trend</h3>
                    <span class="text-xs text-sub">Last 30 days</span>
                </div>
                <canvas id="chart-daily"></canvas>
            </div>
        </div>

        <!-- SKU table -->
        <div class="card p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-lg text-gray-100">SKU Breakdown</h3>
                <span class="text-xs text-sub">Sorted by volume</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead>
                        <tr class="text-sub border-b border-slate-800">
                            <th class="py-3 pr-4 font-semibold">SKU</th>
                            <th class="py-3 pr-4 font-semibold">Total</th>
                            <th class="py-3 pr-4 font-semibold">Pass Rate</th>
                            <th class="py-3 pr-4 font-semibold">Avg ΔE</th>
                            <th class="py-3 pr-4 font-semibold">Avg Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="sku-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chartJudgment, chartRetake, chartDaily;

        function getDateRangeParams() {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            const params = new URLSearchParams();
            if (start) params.append('start_date', `${start}T00:00:00Z`);
            if (end) params.append('end_date', `${end}T23:59:59Z`);
            if (!start && !end) params.append('days', '30');
            return params;
        }

        function applyFilters() {
            loadSummary();
            loadJudgmentChart();
            loadRetakeChart();
            loadDailyChart();
            loadSkuTable();
        }

        function resetFilters() {
            document.getElementById('filter-sku').value = '';
            document.getElementById('filter-start').value = '';
            document.getElementById('filter-end').value = '';
            applyFilters();
        }

        async function loadSummary() {
            const params = getDateRangeParams();
            const sku = document.getElementById('filter-sku').value;
            if (sku) params.append('sku_code', sku);

            const res = await fetch(`/api/inspection/history/stats/summary?${params}`);
            const data = await res.json();
            document.getElementById('stat-total').textContent = data.total_inspections ?? '-';
            document.getElementById('stat-pass-rate').textContent = data.pass_rate !== undefined ? `${(data.pass_rate * 100).toFixed(1)}%` : '-';
            document.getElementById('stat-avg-delta-e').textContent = data.avg_delta_e !== undefined ? data.avg_delta_e.toFixed(2) : '-';
            document.getElementById('stat-avg-confidence').textContent = data.avg_confidence !== undefined ? `${(data.avg_confidence * 100).toFixed(1)}%` : '-';
            if (data.time_range) {
                document.getElementById('stat-range').textContent = `${data.time_range.start.split('T')[0]} ~ ${data.time_range.end.split('T')[0]}`;
            }
        }

        async function loadJudgmentChart() {
            const params = getDateRangeParams();
            const sku = document.getElementById('filter-sku').value;
            if (sku) params.append('sku_code', sku);
            const res = await fetch(`/api/inspection/history/stats/summary?${params}`);
            const data = await res.json();
            const counts = data.judgment_counts || {};
            const labels = ['OK', 'OK_WITH_WARNING', 'NG', 'RETAKE'];
            const values = labels.map(label => counts[label] || 0);

            const ctx = document.getElementById('chart-judgment').getContext('2d');
            if (chartJudgment) chartJudgment.destroy();
            chartJudgment = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#34d399', '#fbbf24', '#f87171', '#a78bfa'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });
        }

        async function loadRetakeChart() {
            const params = getDateRangeParams();
            const sku = document.getElementById('filter-sku').value;
            if (sku) params.append('sku_code', sku);
            const res = await fetch(`/api/inspection/history/stats/retake-reasons?${params}`);
            const data = await res.json();
            const labels = (data.reasons || []).map(r => r.code);
            const values = (data.reasons || []).map(r => r.count);

            const ctx = document.getElementById('chart-retake').getContext('2d');
            if (chartRetake) chartRetake.destroy();
            chartRetake = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Count',
                        data: values,
                        backgroundColor: '#60a5fa'
                    }]
                },
                options: {
                    scales: {
                        x: { ticks: { color: '#e2e8f0' }, grid: { display: false } },
                        y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255,255,255,0.08)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function loadDailyChart() {
            const params = getDateRangeParams();
            const sku = document.getElementById('filter-sku').value;
            if (sku) params.append('sku_code', sku);
            const res = await fetch(`/api/inspection/history/stats/daily?${params}`);
            const data = await res.json();
            const labels = (data.series || []).map(p => p.date);
            const passRates = (data.series || []).map(p => (p.pass_rate || 0) * 100);

            const ctx = document.getElementById('chart-daily').getContext('2d');
            if (chartDaily) chartDaily.destroy();
            chartDaily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Pass %',
                        data: passRates,
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34,211,238,0.12)',
                        tension: 0.25,
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        x: { ticks: { color: '#e2e8f0' }, grid: { display: false } },
                        y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255,255,255,0.08)' }, beginAtZero: true, max: 100 }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });
        }

        async function loadSkuTable() {
            const params = getDateRangeParams();
            const res = await fetch(`/api/inspection/history/stats/by-sku?${params}`);
            const data = await res.json();
            const tbody = document.getElementById('sku-table');
            const entries = Object.entries(data.stats_by_sku || {}).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-sub">No data</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(([sku, stats]) => `
                <tr class="border-b border-slate-800">
                    <td class="py-3 pr-4 font-medium text-gray-100">${sku}</td>
                    <td class="py-3 pr-4 text-sub">${stats.total}</td>
                    <td class="py-3 pr-4 text-sub">${(stats.pass_rate * 100).toFixed(1)}%</td>
                    <td class="py-3 pr-4 text-sub">${stats.avg_delta_e.toFixed(2)}</td>
                    <td class="py-3 pr-4 text-sub">${(stats.avg_confidence * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        // Init
        window.addEventListener('load', () => {
            applyFilters();
        });
    </script>
</body>
</html>
