{% extends "_base_layout.html" %}

{% block title %}Color Meter v7 | Inspection Console{% endblock %}

{% block extra_head %}
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    slate: { 850: '#151e32', 900: '#0f172a', 950: '#020617' },
                    brand: { 500: '#3b82f6', 600: '#2563eb' },
                    status: { ok: '#10b981', warn: '#f59e0b', ng: '#ef4444' }
                }
            }
        }
    }
</script>
<script src="/static/vendor/chart.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/chart.js'"></script>

<style>
    /* V7 Console specific layout - hide footer for full-height experience */
    body {
        overflow: hidden;
    }

    footer {
        display: none !important;
    }

    .main-content-v7 {
        min-height: calc(100vh - 73px); /* Subtract main nav height */
        overflow: hidden;
    }

    /* Grid background effect */
    .main-content-v7::before {
        content: '';
        position: fixed;
        inset: 0;
        top: 73px;
        background-image: linear-gradient(to right, rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                          linear-gradient(to bottom, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
        background-size: 20px 20px;
        pointer-events: none;
        z-index: 0;
    }

    .content-wrapper {
        position: relative;
        z-index: 1;
    }

    /* Sub Navigation - replaces sidebar */
    .sub-nav {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-panel);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-default);
    }

    .sub-nav-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        color: var(--text-dim);
        border-radius: var(--radius-md);
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        background: transparent;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .sub-nav-btn:hover {
        background: var(--bg-elevated);
        color: var(--text-primary);
    }

    .sub-nav-btn.active {
        background: var(--color-primary);
        color: white;
    }

    .sub-nav-btn i {
        width: 18px;
        text-align: center;
    }

    /* Tab content */
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-out;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Image Viewer */
    .image-viewer {
        background: #000;
        border: 1px solid var(--border-dim);
        position: relative;
        overflow: hidden;
        border-radius: var(--radius-lg);
    }

    .viz-toggle {
        display: flex;
        gap: 4px;
        background: rgba(0,0,0,0.3);
        padding: 4px;
        border-radius: 6px;
    }

    .viz-button {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        color: var(--text-dim);
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        background: transparent;
    }

    .viz-button.active {
        background: var(--color-primary);
        color: white;
    }

    /* Data Grid */
    .data-grid {
        display: grid;
        gap: 12px;
    }

    .data-cell {
        background: rgba(255,255,255,0.03);
        padding: 12px;
        border-radius: var(--radius-md);
        border-left: 3px solid var(--border-dim);
    }

    .data-label {
        font-size: 11px;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
    }

    .data-value {
        font-family: var(--font-mono);
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Ink Palette */
    .ink-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(0,0,0,0.2);
        border-radius: var(--radius-md);
        border: 1px solid rgba(255,255,255,0.05);
    }

    .ink-swatch-split {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .ink-swatch-half {
        flex: 1;
        height: 100%;
    }

    /* Scrollable content area */
    .v7-scroll-area {
        height: calc(100vh - 73px - 80px); /* viewport - main nav - sub nav area */
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content-v7 content-wrapper">
    <div class="container mx-auto px-6 py-4">
        <!-- Sub Navigation (replaces sidebar) -->
        <div class="flex items-center justify-between mb-4">
            <nav class="sub-nav">
                <button onclick="switchTab('inspection')" id="tab-inspection" class="sub-nav-btn active">
                    <i class="fa-solid fa-crosshairs"></i>
                    <span>Inspection</span>
                </button>
                <button onclick="switchTab('registration')" id="tab-registration" class="sub-nav-btn">
                    <i class="fa-solid fa-layer-group"></i>
                    <span>Registration</span>
                </button>
                <button onclick="switchTab('std-admin')" id="tab-std-admin" class="sub-nav-btn">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>History</span>
                </button>
                <button onclick="switchTab('test')" id="tab-test" class="sub-nav-btn">
                    <i class="fa-solid fa-flask"></i>
                    <span>Test Lab</span>
                </button>
            </nav>

            <div class="flex items-center gap-3">
                <span class="text-xs font-mono text-dim hidden md:block">V7 Signature Engine Console</span>
                <button id="btnRefreshProducts" class="btn-icon btn-secondary" aria-label="Refresh products" title="Refresh products">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </div>
        </div>

        <!-- Scrollable Content Area -->
        <div class="v7-scroll-area">
            <div class="max-w-[1600px] mx-auto space-y-6 pb-6">

                <!-- INSPECTION TAB -->
                <div id="view-inspection" class="tab-content active space-y-6">
                    <div class="terminal-panel p-6">
                        <!-- Control Bar -->
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
                            <div class="md:col-span-3">
                                <label class="data-label">Product</label>
                                <select id="inspProductSelect" class="terminal-input">
                                    <option value="" disabled selected>Select SKU...</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="data-label">Image</label>
                                <div class="relative">
                                    <input id="inspFiles" type="file" class="absolute inset-0 opacity-0 cursor-pointer">
                                    <div class="terminal-input truncate flex items-center justify-between pointer-events-none">
                                        <span id="inspFileName" class="text-dim">Upload Image...</span>
                                        <i class="fa-solid fa-upload"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="data-label">Mode</label>
                                <select id="inspMode" class="terminal-input">
                                    <option value="all" selected>All</option>
                                    <option value="pattern">Pattern & Color</option>
                                    <option value="gate">Gate Only</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="data-label">Expected Ink</label>
                                <input id="inspInkCountDisplay" class="terminal-input text-center" value="-" disabled>
                            </div>
                            <div class="md:col-span-2 flex items-end">
                                <button id="btnInspect" class="btn btn-primary w-full">Run Inspection</button>
                            </div>
                        </div>

                        <!-- Result Area -->
                        <div id="inspResultArea" class="hidden space-y-6">
                            <!-- Unified Summary Card -->
                            <div id="unifiedSummaryCard"></div>

                            <!-- Judgment Bar -->
                            <div id="inspSummaryCard" class="terminal-panel p-4 flex flex-col md:flex-row items-center justify-between gap-4 border-l-4 border-slate-600">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <span id="inspLabel" class="text-3xl font-black">READY</span>
                                        <span id="inspVersionBadge" class="text-xs font-mono text-dim px-2 py-1 rounded bg-white/5">-</span>
                                        <span id="inspUncertainBadge" class="hidden text-xs font-bold text-warning border border-warning px-2 py-1 rounded">UNCERTAIN</span>
                                    </div>
                                    <p id="inspSummaryLine" class="text-sm text-secondary mt-1">-</p>
                                </div>
                                <div class="flex gap-2">
                                    <button id="inspActionPrimary" class="btn btn-secondary text-xs font-bold">CONFIRM</button>
                                    <button id="inspActionSecondary" class="btn btn-secondary text-xs">DETAILS</button>
                                </div>
                            </div>

                            <!-- Reason Cards -->
                            <div id="inspReasonCards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                            <!-- Visual Viewer -->
                            <div class="terminal-panel p-1 rounded-xl overflow-hidden relative">
                                <div class="absolute top-4 right-4 z-10 flex gap-2">
                                    <button onclick="setViz('overlay')" id="viz-overlay" class="viz-button active bg-black/50 backdrop-blur hover:bg-brand-600">OVERLAY</button>
                                    <button onclick="setViz('heatmap')" id="viz-heatmap" class="viz-button bg-black/50 backdrop-blur hover:bg-brand-600">HEATMAP</button>
                                </div>
                                <div id="analysisViewer" class="image-viewer aspect-[21/9]">
                                    <div id="analysisCanvasWrap" class="w-full h-full relative">
                                        <img id="inspMainImg" class="w-full h-full object-contain" src="">
                                        <canvas id="hotspotOverlay" class="absolute inset-0 w-full h-full"></canvas>
                                    </div>
                                    <div id="inspImageEmpty" class="absolute inset-0 flex items-center justify-center text-dim">Waiting for image...</div>
                                    <div id="hotspotTooltip" class="hidden absolute bg-surface border border-default p-2 rounded text-xs z-50 pointer-events-none shadow-xl"></div>
                                </div>
                            </div>

                            <!-- Detail Panels -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Signature & Color Details -->
                                <div id="signatureArea" class="terminal-panel p-6">
                                    <h3 class="text-lg font-bold mb-4">Signature & Color Details</h3>
                                    <div id="signatureContent"></div>
                                </div>

                                <!-- Ink Analysis -->
                                <div id="inkAnalysisArea" class="terminal-panel p-6">
                                    <h3 class="text-lg font-bold mb-4">Ink Analysis</h3>
                                    <div id="inkAnalysisContent"></div>
                                </div>
                            </div>

                            <!-- Gate Checks -->
                            <div id="gateChecksArea" class="terminal-panel p-6">
                                <h3 class="text-lg font-bold mb-4">Gate Checks</h3>
                                <div id="gateChecksContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REGISTRATION TAB -->
                <div id="view-registration" class="tab-content space-y-6">
                    <div class="terminal-panel p-6">
                        <h2 class="text-2xl font-bold mb-6">STD Registration</h2>
                        <div id="regContent"></div>
                    </div>
                </div>

                <!-- HISTORY TAB -->
                <div id="view-std-admin" class="tab-content space-y-6">
                    <div class="terminal-panel p-6">
                        <h2 class="text-2xl font-bold mb-6">STD History</h2>
                        <div id="historyContent"></div>
                    </div>
                </div>

                <!-- TEST LAB TAB -->
                <div id="view-test" class="tab-content space-y-6">
                    <div class="terminal-panel p-6">
                        <h2 class="text-2xl font-bold mb-6">Test Lab</h2>
                        <div id="testContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- ES6 Modules -->
<script type="module">
    // Import core modules
    import { appState } from '/static/js/core/state.js';
    import { apiClient, v7Api } from '/static/js/core/api.js';

    // Import utilities
    import { byId } from '/static/js/utils/helpers.js';
    import { showNotification } from '/static/js/utils/notifications.js';

    // Import feature modules
    import { initInspection } from '/static/js/features/inspection/inspection.js';
    import { initRegistration } from '/static/js/features/registration/registration.js';
    import { initStdAdmin } from '/static/js/features/history/std_admin.js';
    import { initTestTab } from '/static/js/features/test/test.js';
    import { loadProducts, setupProductListeners } from '/static/js/features/inspection/products.js';
    import { initResultTabs } from '/static/js/components/tabs.js';

    // Import visualization modules
    import * as visuals from '/static/js/components/visuals.js';
    import * as diagnosticsVisuals from '/static/js/features/inspection/diagnostics_visuals.js';
    import * as uiImprovements from '/static/js/components/ui_improvements.js';

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize all modules
        initInspection();
        initRegistration();
        initStdAdmin();
        initTestTab();
        initResultTabs();

        // Load products
        loadProducts();
        setupProductListeners();

        // Global debug access
        window.appState = appState;
        window.apiClient = apiClient;
        window.v7Api = v7Api;

        // For backward compatibility, expose visuals globally
        window.v7 = window.v7 || {};
        window.v7.render = visuals;
        window.v7.uiImprovements = uiImprovements;
    });
</script>

<script>
    // Tab switching function
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Deactivate all buttons
        document.querySelectorAll('.sub-nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(`view-${tabName}`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Visualization toggle
    function setViz(mode) {
        document.querySelectorAll('.viz-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`viz-${mode}`).classList.add('active');

        // Actual viz switching logic handled by existing JS
        if (window.v7 && window.v7.setVisualizationMode) {
            window.v7.setVisualizationMode(mode);
        }
    }

    // Highlight active nav link for /v7
    document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === '/v7') {
                link.classList.add('active');
            }
        });
    });
</script>
{% endblock %}
