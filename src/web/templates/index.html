<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Meter Analysis Dashboard</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; }
        .sidebar { height: 100vh; position: fixed; top: 0; left: 0; padding-top: 60px; background-color: #ffffff; border-right: 1px solid #dee2e6; z-index: 1000; }
        .main-content { margin-left: 280px; padding: 20px; padding-top: 80px; }
        .viewer-container { position: relative; width: 100%; height: 500px; background-color: #333; display: flex; justify-content: center; align-items: center; overflow: hidden; border-radius: 8px; }
        #sourceImage { max-height: 100%; max-width: 100%; display: block; }
        #overlayCanvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        .nav-link.active { font-weight: bold; border-bottom: 2px solid #0d6efd; }
        .card-header { font-weight: 600; background-color: #fff; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Spinner overlay */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 fw-bold">Analyzing...</p>
        </div>
    </div>

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-bullseye"></i> Color Meter <span class="badge bg-info text-dark">Analysis Mode</span>
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar: Controls -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Input Source</span>
                    </h6>
                    <div class="px-3 mb-3">
                        <label for="uploadImage" class="form-label text-small">Image File</label>
                        <input class="form-control form-control-sm" type="file" id="uploadImage" accept="image/*">
                    </div>
                    <div class="px-3 mb-3">
                        <label for="skuSelect" class="form-label text-small">Target SKU</label>
                        <select class="form-select form-select-sm" id="skuSelect">
                            <option value="SKU001" selected>SKU001 (Default)</option>
                            <option value="SKU002">SKU002</option>
                        </select>
                    </div>

                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Analysis Parameters</span>
                    </h6>
                    <div class="px-3 mb-3">
                        <label for="smoothingWindow" class="form-label text-small">Smoothing Window: <span id="swVal">5</span></label>
                        <input type="range" class="form-range" min="3" max="21" step="2" value="5" id="smoothingWindow">
                    </div>
                    <div class="px-3 mb-3">
                        <label for="gradThreshold" class="form-label text-small">Gradient Threshold: <span id="gtVal">0.5</span></label>
                        <input type="range" class="form-range" min="0.1" max="5.0" step="0.1" value="0.5" id="gradThreshold">
                    </div>

                    <div class="d-grid gap-2 px-3 mt-4">
                        <button class="btn btn-primary btn-sm" id="btnAnalyze">
                            <i class="bi bi-play-fill"></i> Run Analysis
                        </button>
                    </div>

                    <hr>
                    <div class="px-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="chkShowOverlay" checked>
                            <label class="form-check-label" for="chkShowOverlay">Show Overlay</label>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">

                <!-- Viewer Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-image"></i> Interactive Viewer</span>
                                <span class="badge bg-secondary" id="imgDims">- x -</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="viewer-container" id="viewerContainer">
                                    <!-- Image and Canvas will be injected here -->
                                    <p class="text-white-50" id="placeholderText">Please upload an image to start.</p>
                                    <img id="sourceImage" style="display:none;" />
                                    <canvas id="overlayCanvas"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results Section -->
                <div class="row">
                    <!-- Tabs -->
                    <div class="col-12 mb-3">
                        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab"><i class="bi bi-card-text"></i> ÏöîÏïΩ</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ink-tab" data-bs-toggle="tab" data-bs-target="#ink-pane" type="button" role="tab"><i class="bi bi-palette"></i> ÏûâÌÅ¨ Ï†ïÎ≥¥</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail-pane" type="button" role="tab"><i class="bi bi-activity"></i> ÏÉÅÏÑ∏ Î∂ÑÏÑù</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs-pane" type="button" role="tab"><i class="bi bi-graph-up"></i> Í∑∏ÎûòÌîÑ</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="candidates-tab" data-bs-toggle="tab" data-bs-target="#candidates-pane" type="button" role="tab">ÌõÑÎ≥¥Íµ∞</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-pane" type="button" role="tab">Raw Data</button>
                            </li>
                        </ul>
                    </div>

                    <div class="col-12">
                        <div class="tab-content" id="resultTabsContent">
                            <!-- Tab 1: Summary (ÏöîÏïΩ) -->
                            <div class="tab-pane fade show active" id="summary-pane" role="tabpanel">
                                <div class="card shadow-sm border-0">
                                    <div class="card-header text-white" id="summary-header" style="background-color: #6c757d;">
                                        <h5 class="mb-0 fw-bold"><i class="bi bi-clipboard-check"></i> ÌåêÏ†ï: <span id="summaryResult">READY</span></h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-4 text-center">
                                            <div class="col-md-4 border-end">
                                                <div class="text-muted small">Confidence</div>
                                                <div class="fs-4 fw-bold" id="summaryConfidence">-</div>
                                            </div>
                                            <div class="col-md-4 border-end">
                                                <div class="text-muted small">Overall ŒîE</div>
                                                <div class="fs-4 fw-bold" id="summaryDeltaE">-</div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-muted small">Detected Zones</div>
                                                <div class="fs-4 fw-bold" id="summaryZones">-</div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="border-bottom pb-2 text-secondary"><i class="bi bi-search"></i> ÌåêÏ†ï Ïù¥Ïú† (Decision Trace)</h6>
                                                <ul id="summaryBecause" class="list-group list-group-flush small mb-3">
                                                    <li class="list-group-item text-muted">Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="border-bottom pb-2 text-secondary"><i class="bi bi-check-circle"></i> Í∂åÏû• Ï°∞Ïπò (Next Actions)</h6>
                                                <ol id="summaryActions" class="list-group list-group-numbered list-group-flush small">
                                                    <li class="list-group-item text-muted">Î∂ÑÏÑù ÎåÄÍ∏∞ Ï§ë</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 2: Ink Info (ÏûâÌÅ¨ Ï†ïÎ≥¥) -->
                            <div class="tab-pane fade" id="ink-pane" role="tabpanel">
                                <!-- üîß FIX: Zone-BasedÎ•º Î©îÏù∏ÏúºÎ°ú (ÏÉâÏÉÅ Ï∂îÏ∂ú Ï†ïÌôïÎèÑÍ∞Ä Îçî ÎÜíÏùå) -->
                                <!-- Zone-Based Analysis (Ïã§Ï†ú ÏÉâÏÉÅ Î∂ÑÏÑù) -->
                                <div class="card shadow-sm border-success border-2 mb-3">
                                    <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-bullseye"></i> Ïã§Ï†ú ÏÉâÏÉÅ Î∂ÑÏÑù (Zone-Based)</span>
                                        <span class="badge bg-white text-success">Í∂åÏû•</span>
                                    </div>
                                    <div class="card-body py-2 bg-success bg-opacity-10 d-flex justify-content-between">
                                        <span><strong>Í≤ÄÏ∂úÎêú ÏûâÌÅ¨ Ïàò:</strong> <span id="inkCountZone" class="fs-5 text-success fw-bold">-</span></span>
                                        <span><strong>Î∞©Ïãù:</strong> <span id="inkMethodZone">-</span></span>
                                    </div>
                                    <div class="alert alert-info mx-3 mb-2 mt-2 py-2 small">
                                        <i class="bi bi-info-circle"></i> <strong>Ï†ïÌôïÎèÑ:</strong> 3Îã®Í≥Ñ ÌïÑÌÑ∞ÎßÅ(Zone+Lens+Ink)ÏúºÎ°ú ÏàúÎèÑ 99%, ÌëúÏ§ÄÌé∏Ï∞® ¬±0.5 ŒîE Ïù¥ÎÇ¥Ïùò ÎÜíÏùÄ ÏÉâÏÉÅ Ï†ïÌôïÎèÑÎ•º Ï†úÍ≥µÌï©ÎãàÎã§.
                                    </div>
                                    <div id="inkListZone" class="p-3">
                                        <!-- Ink Cards Injected Here -->
                                        <div class="text-center text-muted py-3">Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
                                    </div>
                                </div>

                                <!-- Image-Based Analysis (Ï∞∏Í≥†Ïö©) -->
                                <div class="card shadow-sm border-0 mb-2">
                                    <div class="card-header bg-light text-dark fw-bold" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#imageBased">
                                        <i class="bi bi-diagram-3"></i> ÏûâÌÅ¨ Í∞úÏàò Í≤ÄÏ¶ù (Image-Based / GMM)
                                        <small class="text-muted">‚ñº ÌéºÏπòÍ∏∞</small>
                                    </div>
                                    <div id="imageBased" class="collapse">
                                        <div class="card-body py-2 bg-light d-flex justify-content-between">
                                            <span><strong>Í≤ÄÏ∂úÎêú ÏûâÌÅ¨ Ïàò:</strong> <span id="inkCountImage">-</span></span>
                                            <span><strong>Î∞©Ïãù:</strong> <span id="inkMethodImage">-</span></span>
                                        </div>

                                        <!-- üé® C) ÏÉâÏÉÅ ÌåîÎ†àÌä∏ ÏÑπÏÖò (ÎèôÏ†Å Í∞úÏàò) -->
                                        <div id="inkPalette" class="px-3 pt-3 pb-2" style="display: none;">
                                            <div class="fw-bold mb-2 small text-muted">
                                                <i class="bi bi-palette"></i> Í≤ÄÏ∂úÎêú ÏûâÌÅ¨ ÏÉâÏÉÅ
                                            </div>
                                            <div id="inkPaletteColors" class="d-flex gap-2 flex-wrap">
                                                <!-- ÏÉâÏÉÅ Ïπ©Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                                            </div>
                                        </div>

                                        <div id="inkListImage" class="p-3">
                                            <!-- Ink Cards Injected Here -->
                                            <div class="text-center text-muted py-3">Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 3: Detailed Analysis (ÏÉÅÏÑ∏ Î∂ÑÏÑù) -->
                            <div class="tab-pane fade" id="detail-pane" role="tabpanel">
                                <div class="row g-3">
                                    <!-- Confidence Breakdown -->
                                    <div class="col-md-6">
                                        <div class="card shadow-sm h-100">
                                            <div class="card-header bg-white fw-bold"><i class="bi bi-bar-chart"></i> Confidence Breakdown</div>
                                            <div class="card-body">
                                                <ul class="list-group list-group-flush small" id="confidenceList">
                                                    <li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Risk Factors -->
                                    <div class="col-md-6">
                                        <div class="card shadow-sm h-100">
                                            <div class="card-header bg-white fw-bold"><i class="bi bi-exclamation-triangle"></i> Risk Factors</div>
                                            <div class="card-body">
                                                <ul class="list-group list-group-flush small" id="riskList">
                                                    <li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Analysis Summary -->
                                    <div class="col-12">
                                        <div class="card shadow-sm">
                                            <div class="card-header bg-white fw-bold"><i class="bi bi-file-earmark-text"></i> Analysis Summary (ÌîÑÎ°úÌååÏùº ÏöîÏïΩ)</div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-4">
                                                        <h6 class="text-secondary small mb-2"><i class="bi bi-speedometer2"></i> Í∑†ÏùºÏÑ± (Uniformity)</h6>
                                                        <ul class="list-group list-group-flush small" id="summaryUniformity">
                                                            <li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>
                                                        </ul>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <h6 class="text-secondary small mb-2"><i class="bi bi-bullseye"></i> Í≤ΩÍ≥Ñ ÌíàÏßà (Boundary Quality)</h6>
                                                        <ul class="list-group list-group-flush small" id="summaryBoundary">
                                                            <li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>
                                                        </ul>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <h6 class="text-secondary small mb-2"><i class="bi bi-grid-3x3"></i> Ïª§Î≤ÑÎ¶¨ÏßÄ (Coverage)</h6>
                                                        <ul class="list-group list-group-flush small" id="summaryCoverage">
                                                            <li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 4: Graphs (Í∑∏ÎûòÌîÑ) -->
                            <div class="tab-pane fade" id="graphs-pane" role="tabpanel">
                                <div class="card shadow-sm mb-3">
                                    <div class="card-header bg-white pt-1 pb-1">Radial Profile (L, a, b)</div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="profileChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="card shadow-sm">
                                    <div class="card-header bg-white pt-1 pb-1">Gradients (Changes)</div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 250px;">
                                            <canvas id="gradientChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 5: Candidates -->
                            <div class="tab-pane fade" id="candidates-pane" role="tabpanel">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <table class="table table-hover table-sm" id="candidatesTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Method</th>
                                                    <th>Radius (norm)</th>
                                                    <th>Value</th>
                                                    <th>Confidence</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Rows injected by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 6: Raw JSON -->
                            <div class="tab-pane fade" id="json-pane" role="tabpanel">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-end mb-2 gap-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="downloadJson()"><i class="bi bi-download"></i> Download .json</button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="copyRawJson()"><i class="bi bi-clipboard"></i> Copy JSON</button>
                                        </div>
                                        <pre id="rawJsonViewer" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.85em;"></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Log Console Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card shadow-sm border-secondary">
                            <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                                <span class="small fw-bold"><i class="bi bi-terminal"></i> System Logs</span>
                                <button class="btn btn-xs btn-outline-secondary py-0" style="font-size: 0.75rem;" onclick="clearLogs()">Clear</button>
                            </div>
                            <div class="card-body p-0">
                                <div id="logConsole" style="height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; padding: 10px; background-color: #1e1e1e; color: #00ff00;">
                                    <div class="text-muted">> System ready.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- Global State ---
        let currentImageFile = null;
        let analysisData = null;
        const viewerContainer = document.getElementById('viewerContainer');
        const imgElement = document.getElementById('sourceImage');
        const canvas = document.getElementById('overlayCanvas');
        const ctx = canvas.getContext('2d');
        const logConsole = document.getElementById('logConsole');

        let profileChart = null;
        let gradientChart = null;

        // --- Logging Function ---
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.marginBottom = '2px';
            if (type === 'error') div.style.color = '#ff4444';
            else if (type === 'success') div.style.color = '#00cc00';
            else div.style.color = '#cccccc';

            div.innerHTML = `<span style="opacity:0.5">[${now}]</span> ${message}`;
            logConsole.appendChild(div);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function clearLogs() {
            logConsole.innerHTML = '<div class="text-muted">> Logs cleared.</div>';
        }

        // --- Event Listeners ---
        document.getElementById('smoothingWindow').addEventListener('input', (e) => document.getElementById('swVal').textContent = e.target.value);
        document.getElementById('gradThreshold').addEventListener('input', (e) => document.getElementById('gtVal').textContent = e.target.value);

        document.getElementById('uploadImage').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                currentImageFile = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imgElement.src = evt.target.result;
                    imgElement.style.display = 'block';
                    document.getElementById('placeholderText').style.display = 'none';
                    log("Image loaded locally: " + currentImageFile.name);

                    // Resize canvas to match image when loaded
                    imgElement.onload = () => {
                        // Canvas ÎÇ¥Î∂Ä Ìï¥ÏÉÅÎèÑÎäî ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Î°ú ÏÑ§Ï†ï
                        canvas.width = imgElement.naturalWidth;
                        canvas.height = imgElement.naturalHeight;

                        // Canvas ÌëúÏãú ÌÅ¨Í∏∞ÏôÄ ÏúÑÏπòÎ•º Ïù¥ÎØ∏ÏßÄÏôÄ ÎèôÍ∏∞Ìôî
                        const imgRect = imgElement.getBoundingClientRect();
                        const containerRect = viewerContainer.getBoundingClientRect();

                        canvas.style.width = imgElement.clientWidth + 'px';
                        canvas.style.height = imgElement.clientHeight + 'px';
                        canvas.style.left = (imgRect.left - containerRect.left) + 'px';
                        canvas.style.top = (imgRect.top - containerRect.top) + 'px';

                        document.getElementById('imgDims').textContent = `${imgElement.naturalWidth} x ${imgElement.naturalHeight}`;
                        clearOverlay();
                    };
                };
                reader.readAsDataURL(currentImageFile);
            }
        });

        document.getElementById('btnAnalyze').addEventListener('click', runAnalysis);

        // --- Functions ---

        async function runAnalysis() {
            if (!currentImageFile) {
                log("Error: No image selected.", 'error');
                return;
            }

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            log("Starting analysis...", 'info');

            const formData = new FormData();
            formData.append('file', currentImageFile);
            formData.append('sku', document.getElementById('skuSelect').value);
            formData.append('smoothing_window', document.getElementById('smoothingWindow').value);
            formData.append('gradient_threshold', document.getElementById('gradThreshold').value);

            try {
                const response = await fetch('/inspect_v2', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                analysisData = await response.json();
                log("Analysis successful!", 'success');
                console.log("Analysis Result:", analysisData);

                // Update New Tabs
                updateSummaryTab(analysisData);
                updateInkTab(analysisData);
                updateDetailTab(analysisData);

                // Existing Updates
                updateCharts(analysisData);
                updateCandidatesTable(analysisData.analysis.boundary_candidates);
                drawOverlay(analysisData);

                // Update Raw JSON view
                document.getElementById('rawJsonViewer').textContent = JSON.stringify(analysisData, null, 2);

            } catch (error) {
                console.error(error);
                log("Analysis failed: " + error.message, 'error');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function updateSummaryTab(data) {
            const j = data.judgment;
            if (!j) return;

            // 1. Result Badge
            const badge = document.getElementById('summaryResult');
            let badgeClass = 'badge fs-4 px-4 py-2 ';
            if (j.result === 'OK') badgeClass += 'bg-success';
            else if (j.result === 'OK_WITH_WARNING') badgeClass += 'bg-warning text-dark';
            else if (j.result === 'RETAKE') badgeClass += 'bg-secondary';
            else badgeClass += 'bg-danger';

            badge.className = badgeClass;
            badge.textContent = j.result;

            // 2. Metrics
            document.getElementById('summaryConfidence').textContent = j.confidence ? j.confidence.toFixed(2) : '-';
            document.getElementById('summaryDeltaE').textContent = j.overall_delta_e ? j.overall_delta_e.toFixed(2) : '-';
            document.getElementById('summaryZones').textContent = j.zones ? j.zones.length : '-';

            // 3. Decision Trace
            const becauseList = document.getElementById('summaryBecause');
            becauseList.innerHTML = '';
            if (j.decision_trace && j.decision_trace.because) {
                j.decision_trace.because.forEach(reason => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<i class="bi bi-dot"></i> ${reason}`;
                    becauseList.appendChild(li);
                });
                if (j.decision_trace.overrides) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item text-muted fst-italic';
                    li.innerHTML = `<i class="bi bi-exclamation-circle"></i> Override: ${j.decision_trace.overrides}`;
                    becauseList.appendChild(li);
                }
            } else {
                becauseList.innerHTML = '<li class="list-group-item text-muted">Ï†ïÎ≥¥ ÏóÜÏùå</li>';
            }

            // 4. Next Actions
            const actionsList = document.getElementById('summaryActions');
            actionsList.innerHTML = '';
            if (j.next_actions && j.next_actions.length > 0) {
                j.next_actions.forEach(action => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = action;
                    actionsList.appendChild(li);
                });
            } else {
                actionsList.innerHTML = '<li class="list-group-item text-muted">ÌäπÏù¥ÏÇ¨Ìï≠ ÏóÜÏùå</li>';
            }
        }

        function updateInkTab(data) {
            const ink = data.judgment.ink_analysis;

            if (!ink) {
                document.getElementById('inkListZone').innerHTML = '<div class="text-center text-muted py-3">ÏûâÌÅ¨ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                document.getElementById('inkListImage').innerHTML = '<div class="text-center text-muted py-3">ÏûâÌÅ¨ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            // ========== Zone-Based Analysis ==========
            const zoneData = ink.zone_based;
            if (zoneData) {
                document.getElementById('inkCountZone').textContent = zoneData.detected_ink_count || '-';
                const methodText = zoneData.detection_method === 'transition_based' ? 'ÏûêÎèô Í≤ÄÏ∂ú (Transition)' : 'Fallback';
                document.getElementById('inkMethodZone').textContent = methodText;

                const containerZone = document.getElementById('inkListZone');
                containerZone.innerHTML = '';

                if (zoneData.inks && zoneData.inks.length > 0) {
                    zoneData.inks.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'card mb-2 shadow-sm border-light';
                        const isOk = item.is_within_spec;
                        const icon = isOk ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>';

                        const m = item.measured_color || {L:0, a:0, b:0};
                        const r = item.reference_color || {L:0, a:0, b:0};

                        // ÏÉâÏÉÅ Ïπ© (measured_colorÏóê rgb/hex Ï∂îÍ∞ÄÎê®)
                        const hex = m.hex || '#808080';
                        const rgb = m.rgb || [128, 128, 128];
                        const colorChipHtml = m.hex ? `
                            <div class="d-inline-block ms-2" style="
                                width: 60px;
                                height: 24px;
                                background-color: ${hex};
                                border: 1px solid #ccc;
                                border-radius: 4px;
                                vertical-align: middle;
                            "></div>
                            <span class="ms-2 badge bg-dark">${hex}</span>
                        ` : '';

                        card.innerHTML = `
                            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                                <span>
                                    <small>[Ink ${item.ink_number}]</small> ${item.zone_name} <small class="text-muted">(${item.position})</small>
                                    ${colorChipHtml}
                                </span>
                                <span>${icon} ŒîE ${item.delta_e ? item.delta_e.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="card-body py-2">
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <div class="text-muted">Ï∏°Ï†ïÍ∞í (Lab)</div>
                                        <div>L=${m.L ? m.L.toFixed(1) : 0}, a=${m.a ? m.a.toFixed(1) : 0}, b=${m.b ? m.b.toFixed(1) : 0}</div>
                                        ${m.rgb ? `<div class="text-muted mt-1">RGB: R=${rgb[0]}, G=${rgb[1]}, B=${rgb[2]}</div>` : ''}
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted">Í∏∞Ï§ÄÍ∞í (Lab)</div>
                                        <div>L=${r.L ? r.L.toFixed(1) : 0}, a=${r.a ? r.a.toFixed(1) : 0}, b=${r.b ? r.b.toFixed(1) : 0}</div>
                                    </div>
                                    <div class="col-12 mt-1 border-top pt-1">
                                        <span class="text-muted">Î∞òÍ≤Ω:</span>
                                        ${item.radial_range ? `${item.radial_range[0].toFixed(2)} ~ ${item.radial_range[1].toFixed(2)}` : 'N/A'}
                                    </div>
                                </div>
                            </div>
                        `;
                        containerZone.appendChild(card);
                    });
                } else {
                    containerZone.innerHTML = '<div class="text-center text-muted py-3">ÏûâÌÅ¨ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
                }
            }

            // ========== Image-Based Analysis ==========
            const imageData = ink.image_based;
            if (imageData) {
                document.getElementById('inkCountImage').textContent = imageData.detected_ink_count || '-';
                document.getElementById('inkMethodImage').textContent = 'GMM + BIC';

                const containerImage = document.getElementById('inkListImage');
                containerImage.innerHTML = '';

                // Meta info display
                if (imageData.meta) {
                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'alert alert-info py-2 small mb-2';
                    let metaText = '';
                    if (imageData.meta.correction_applied) {
                        metaText += '<i class="bi bi-magic"></i> <strong>Mixing Correction Applied</strong>: Ï§ëÍ∞Ñ ÌÜ§Ïù¥ ÌòºÌï©ÏúºÎ°ú ÌåêÎã®ÎêòÏñ¥ ÏûâÌÅ¨ Ïàò Ï°∞Ï†ïÎê® (3‚Üí2)<br>';
                    }
                    if (imageData.meta.sample_count) {
                        metaText += `<i class="bi bi-info-circle"></i> ÏÉòÌîå ÌîΩÏÖÄ Ïàò: ${imageData.meta.sample_count.toLocaleString()}<br>`;
                    }
                    if (imageData.meta.bic) {
                        metaText += `<i class="bi bi-graph-down"></i> BIC Ï†êÏàò: ${imageData.meta.bic.toFixed(2)}`;
                    }
                    if (imageData.meta.error) {
                        metaText = `<i class="bi bi-exclamation-triangle"></i> <strong>Ïò§Î•ò:</strong> ${imageData.meta.error}`;
                        metaDiv.className = 'alert alert-warning py-2 small mb-2';
                    }
                    metaDiv.innerHTML = metaText;
                    containerImage.appendChild(metaDiv);
                }

                if (imageData.inks && imageData.inks.length > 0) {
                    // üé® C) ÏÉâÏÉÅ ÌåîÎ†àÌä∏ ÏÑπÏÖò ÏóÖÎç∞Ïù¥Ìä∏ (ÎèôÏ†Å Í∞úÏàò)
                    const paletteSection = document.getElementById('inkPalette');
                    const paletteColors = document.getElementById('inkPaletteColors');
                    paletteSection.style.display = 'block';
                    paletteColors.innerHTML = '';

                    imageData.inks.forEach((item, idx) => {
                        const lab = item.lab || {0: 0, 1: 0, 2: 0};
                        const rgb = item.rgb || [128, 128, 128];
                        const hex = item.hex || '#808080';
                        const weight = (item.weight * 100).toFixed(1);

                        // ÌåîÎ†àÌä∏ ÏÉâÏÉÅ Ïπ© ÏÉùÏÑ± (ÌÅ∞ Î∞ïÏä§)
                        const chip = document.createElement('div');
                        chip.style.cssText = `
                            flex: 1;
                            min-width: 120px;
                            height: 80px;
                            background-color: ${hex};
                            border-radius: 8px;
                            border: 2px solid #dee2e6;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            color: ${lab[0] > 50 ? '#000' : '#fff'};
                            font-weight: bold;
                        `;
                        chip.innerHTML = `
                            <div style="font-size: 0.75rem; opacity: 0.8;">Ink ${idx + 1}</div>
                            <div style="font-size: 1rem;">${hex}</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">${weight}%</div>
                        `;
                        paletteColors.appendChild(chip);

                        // üîß A) ÏÉÅÏÑ∏ Ïπ¥Îìú: Îçî ÌÅ¨Í≥† ÎààÏóê ÎùÑÎäî ÏÉâÏÉÅ Î∞ïÏä§
                        const card = document.createElement('div');
                        card.className = 'card mb-2 shadow-sm border-light';

                        card.innerHTML = `
                            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                                <span>
                                    <small>[Ink ${idx + 1}]</small>
                                    <div class="d-inline-block ms-2" style="
                                        width: 60px;
                                        height: 24px;
                                        background-color: ${hex};
                                        border: 1px solid #ccc;
                                        border-radius: 4px;
                                        vertical-align: middle;
                                    "></div>
                                    <span class="ms-2 badge bg-dark">${hex}</span>
                                </span>
                                <span class="badge bg-secondary">${weight}%</span>
                            </div>
                            <div class="card-body py-2">
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <div class="text-muted">Lab Í∞í</div>
                                        <div>L=${lab[0].toFixed(1)}, a=${lab[1].toFixed(1)}, b=${lab[2].toFixed(1)}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted">RGB Í∞í</div>
                                        <div>R=${rgb[0]}, G=${rgb[1]}, B=${rgb[2]}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        containerImage.appendChild(card);
                    });
                } else {
                    // ÏûâÌÅ¨ ÏóÜÏúºÎ©¥ ÌåîÎ†àÌä∏ Ïà®ÍπÄ
                    document.getElementById('inkPalette').style.display = 'none';
                    containerImage.innerHTML = '<div class="text-center text-muted py-3">ÏûâÌÅ¨ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
                }
            }
        }

        function updateDetailTab(data) {
            const j = data.judgment;

            // Confidence
            const confList = document.getElementById('confidenceList');
            confList.innerHTML = '';
            if (j.confidence_breakdown && j.confidence_breakdown.factors) {
                j.confidence_breakdown.factors.forEach(f => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';

                    let badgeColor = 'bg-secondary';
                    if (f.score >= 0.9) badgeColor = 'bg-success';
                    else if (f.score >= 0.7) badgeColor = 'bg-warning text-dark';
                    else badgeColor = 'bg-danger';

                    li.innerHTML = `
                        <span><strong>${f.name}</strong> <small class="text-muted">${f.description}</small></span>
                        <span>
                            <span class="badge ${badgeColor} rounded-pill">${f.score.toFixed(2)}</span>
                            <small class="text-muted ms-1">(Í∏∞Ïó¨: ${f.contribution.toFixed(3)})</small>
                        </span>
                    `;
                    confList.appendChild(li);
                });
            } else {
                confList.innerHTML = '<li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
            }

            // Risks
            const riskList = document.getElementById('riskList');
            riskList.innerHTML = '';
            if (j.risk_factors && j.risk_factors.length > 0) {
                j.risk_factors.forEach(r => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    let icon = '<i class="bi bi-info-circle text-info"></i>';
                    if (r.severity === 'high') icon = '<i class="bi bi-exclamation-triangle-fill text-danger"></i>';
                    else if (r.severity === 'medium') icon = '<i class="bi bi-exclamation-circle-fill text-warning"></i>';

                    li.innerHTML = `${icon} <strong>${r.category}:</strong> ${r.message}`;
                    riskList.appendChild(li);
                });
            } else {
                riskList.innerHTML = '<li class="list-group-item text-muted text-success"><i class="bi bi-shield-check"></i> Í∞êÏßÄÎêú ÏúÑÌóò ÏöîÏÜå ÏóÜÏùå</li>';
            }

            // Analysis Summary
            const uniformityList = document.getElementById('summaryUniformity');
            const boundaryList = document.getElementById('summaryBoundary');
            const coverageList = document.getElementById('summaryCoverage');

            uniformityList.innerHTML = '';
            boundaryList.innerHTML = '';
            coverageList.innerHTML = '';

            if (j.analysis_summary) {
                const summary = j.analysis_summary;

                // Uniformity
                if (summary.uniformity) {
                    const u = summary.uniformity;
                    let statusBadge = 'bg-secondary';
                    if (u.status === 'good') statusBadge = 'bg-success';
                    else if (u.status === 'warning') statusBadge = 'bg-warning text-dark';
                    else if (u.status === 'poor') statusBadge = 'bg-danger';

                    uniformityList.innerHTML = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>max_std_L</span>
                            <span class="badge ${statusBadge} rounded-pill">${u.max_std_L.toFixed(1)}</span>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted">ÏûÑÍ≥ÑÍ∞í: Í≤ΩÍ≥†=${u.threshold_warning}, RETAKE=${u.threshold_retake}</small>
                        </li>
                        <li class="list-group-item">
                            <strong>ÏòÅÌñ•:</strong> <span class="text-${u.status === 'good' ? 'success' : (u.status === 'warning' ? 'warning' : 'danger')}">${u.impact}</span>
                        </li>
                    `;
                }

                // Boundary Quality
                if (summary.boundary_quality) {
                    const b = summary.boundary_quality;
                    let statusBadge = 'bg-secondary';
                    if (b.status === 'good') statusBadge = 'bg-success';
                    else if (b.status === 'warning') statusBadge = 'bg-warning text-dark';
                    else if (b.status === 'poor') statusBadge = 'bg-danger';

                    const methodText = b.B_zone_method === 'auto_detected' ? 'ÏûêÎèô Í≤ÄÏ∂ú' : 'Fallback';
                    const methodIcon = b.B_zone_method === 'auto_detected' ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-exclamation-circle text-warning"></i>';

                    boundaryList.innerHTML = `
                        <li class="list-group-item">
                            ${methodIcon} <strong>Í≤ÄÏ∂ú Î∞©Ïãù:</strong> ${methodText}
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Confidence Í∏∞Ïó¨ÎèÑ</span>
                            <span class="badge ${statusBadge} rounded-pill">${b.confidence_contribution.toFixed(3)}</span>
                        </li>
                        <li class="list-group-item">
                            <strong>ÏòÅÌñ•:</strong> <span class="text-${b.status === 'good' ? 'success' : (b.status === 'warning' ? 'warning' : 'danger')}">${b.impact}</span>
                        </li>
                    `;
                }

                // Coverage
                if (summary.coverage) {
                    const c = summary.coverage;
                    let statusBadge = 'bg-secondary';
                    if (c.status === 'good') statusBadge = 'bg-success';
                    else if (c.status === 'poor') statusBadge = 'bg-danger';

                    const percentage = c.expected_min > 0 ? ((c.total_pixels / c.expected_min) * 100).toFixed(1) : 0;

                    coverageList.innerHTML = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Ï¥ù ÌîΩÏÖÄ Ïàò</span>
                            <span class="badge ${statusBadge} rounded-pill">${c.total_pixels.toLocaleString()}</span>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted">Í∏∞ÎåìÍ∞í: ${c.expected_min.toLocaleString()} (${percentage}%)</small>
                        </li>
                        <li class="list-group-item">
                            <strong>ÏòÅÌñ•:</strong> <span class="text-${c.status === 'good' ? 'success' : 'danger'}">${c.impact}</span>
                        </li>
                    `;
                }
            } else {
                uniformityList.innerHTML = '<li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
                boundaryList.innerHTML = '<li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
                coverageList.innerHTML = '<li class="list-group-item text-muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</li>';
            }
        }

        function updateJudgmentTab(data) {
            const judg = data.judgment;
            const badge = document.getElementById('judgBadge');
            const deltaEl = document.getElementById('judgDeltaE');
            const confEl = document.getElementById('judgConf');
            const tbody = document.querySelector('#judgmentTable tbody');

            if (!judg) {
                badge.className = 'badge bg-secondary fs-4 px-4 py-2';
                badge.textContent = 'NO DATA';
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Judgment data not returned</td></tr>';
                return;
            }

            // Overall Badge
            if (judg.result === 'OK') {
                badge.className = 'badge bg-success fs-4 px-4 py-2';
                badge.textContent = 'PASS (OK)';
            } else {
                badge.className = 'badge bg-danger fs-4 px-4 py-2';
                badge.textContent = 'FAIL (NG)';
            }

            deltaEl.textContent = `Overall ŒîE: ${judg.overall_delta_e ? judg.overall_delta_e.toFixed(2) : '-'}`;
            confEl.textContent = judg.confidence ? (judg.confidence * 100).toFixed(1) + '%' : '-';

            // Table
            tbody.innerHTML = '';
            if (judg.zones && judg.zones.length > 0) {
                judg.zones.forEach(z => {
                    const tr = document.createElement('tr');
                    const statusBadge = z.is_ok
                        ? '<span class="badge bg-success">OK</span>'
                        : '<span class="badge bg-danger">NG</span>';

                    tr.innerHTML = `
                        <td class="fw-bold">${z.name}</td>
                        <td>${z.delta_e.toFixed(2)}</td>
                        <td class="text-muted">max ${z.threshold || '-'}</td>
                        <td>${statusBadge}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No zones detected</td></tr>';
            }
        }

        function updateCharts(data) {
            const profile = data.analysis.profile;
            const derivs = data.analysis.derivatives;
            const radius = profile.radius; // x-axis

            // 1. Profile Chart
            if (profileChart) profileChart.destroy();
            const ctx1 = document.getElementById('profileChart').getContext('2d');
            profileChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: radius.map(r => r.toFixed(3)),
                    datasets: [
                        { label: 'L* (Smooth)', data: profile.L_smoothed, borderColor: 'rgb(255, 99, 132)', tension: 0.1, borderWidth: 2 },
                        { label: 'L* (Raw)', data: profile.L_raw, borderColor: 'rgba(255, 99, 132, 0.2)', borderWidth: 1, pointRadius: 0 },
                        { label: 'a* (Smooth)', data: profile.a_smoothed, borderColor: 'rgb(54, 162, 235)', tension: 0.1, borderWidth: 2 },
                        { label: 'b* (Smooth)', data: profile.b_smoothed, borderColor: 'rgb(255, 206, 86)', tension: 0.1, borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { title: { display: true, text: 'Normalized Radius' } },
                        y: { title: { display: true, text: 'Value' } }
                    }
                }
            });

            // 2. Gradient Chart
            if (gradientChart) gradientChart.destroy();
            const ctx2 = document.getElementById('gradientChart').getContext('2d');
            gradientChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: radius.map(r => r.toFixed(3)),
                    datasets: [
                        { label: 'Grad Magnitude', data: derivs.gradient_magnitude, borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.1)' },
                        { label: '2nd Deriv L', data: derivs.second_derivative_L, borderColor: 'rgba(153, 102, 255, 0.6)', borderWidth: 1, borderDash: [5, 5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
            });
        }

        function updateCandidatesTable(candidates) {
            const tbody = document.querySelector('#candidatesTable tbody');
            tbody.innerHTML = '';

            if (!candidates || candidates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No candidates detected</td></tr>';
                return;
            }

            candidates.forEach((c, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="badge bg-secondary">${c.method}</span></td>
                    <td>${c.radius.toFixed(3)}</td>
                    <td>${c.value.toFixed(3)}</td>
                    <td>${c.confidence ? c.confidence.toFixed(2) : '-'}</td>
                    <td><button class="btn btn-sm btn-outline-primary py-0" onclick="highlightBoundary(${index})">Show</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function copyRawJson() {
            const text = document.getElementById('rawJsonViewer').textContent;
            navigator.clipboard.writeText(text).then(() => {
                log("JSON copied to clipboard!", 'success');
            }, (err) => {
                log("Failed to copy JSON: " + err, 'error');
            });
        }

        function downloadJson() {
            if (!analysisData) {
                log("No analysis data to download.", 'error');
                return;
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(analysisData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);

            // Filename: analysis_runID.json
            const filename = `analysis_${analysisData.run_id || 'result'}.json`;
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            log(`JSON file downloaded: ${filename}`, 'success');
        }

        function clearOverlay() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function drawOverlay(data) {
            if (!document.getElementById('chkShowOverlay').checked) return;
            clearOverlay();

            if (data.analysis.lens_info) {
                const { center_x, center_y, radius_px } = data.analysis.lens_info;

                // CanvasÎäî ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Î°ú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú Ï¢åÌëúÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                // (Î∏åÎùºÏö∞Ï†ÄÍ∞Ä CSSÎ°ú ÏûêÎèô Ïä§ÏºÄÏùºÎßÅ)

                // Draw Lens Boundary
                ctx.beginPath();
                ctx.arc(center_x, center_y, radius_px, 0, 2 * Math.PI);
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw Candidates
                data.analysis.boundary_candidates.forEach(c => {
                    const r_px = c.radius * radius_px;
                    ctx.beginPath();
                    ctx.arc(center_x, center_y, r_px, 0, 2 * Math.PI);
                    ctx.strokeStyle = 'rgba(0, 255, 0, 0.7)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                });
            }
        }

        window.highlightBoundary = function(index) {
            // Highlight specific boundary (Red)
            if (!analysisData || !analysisData.analysis.lens_info) return;

            // Redraw all first
            drawOverlay(analysisData);

            const c = analysisData.analysis.boundary_candidates[index];
            const { center_x, center_y, radius_px } = analysisData.analysis.lens_info;
            const r_px = c.radius * radius_px;

            ctx.beginPath();
            ctx.arc(center_x, center_y, r_px, 0, 2 * Math.PI);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.stroke();
        };

        document.getElementById('chkShowOverlay').addEventListener('change', () => {
             if(analysisData) drawOverlay(analysisData);
             else clearOverlay();
        });

    </script>
</body>
</html>
