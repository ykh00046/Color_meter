<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspection History | Color Meter</title>
    <meta name="description" content="검사 이력과 배치 흐름을 한 번에 확인하는 Color Meter 히스토리." />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-0: #070b12;
            --bg-1: #0d1424;
            --panel: rgba(15, 23, 42, 0.86);
            --panel-border: rgba(148, 163, 184, 0.18);
            --primary: #ff9f1c;
            --accent: #33d1ff;
            --text-strong: #f8fafc;
            --text-muted: #94a3b8;
            --success: #44ff8f;
            --warning: #ffd166;
            --danger: #ff6b6b;
            --retake: #7c7cff;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: radial-gradient(circle at 15% 20%, #152341 0%, var(--bg-1) 45%, var(--bg-0) 100%);
            color: var(--text-strong);
        }

        h1, h2, h3 { font-family: 'Fraunces', serif; }
        .mono { font-family: 'IBM Plex Mono', monospace; }

        .grid-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                linear-gradient(90deg, rgba(51, 209, 255, 0.05) 1px, transparent 1px),
                linear-gradient(rgba(255, 159, 28, 0.04) 1px, transparent 1px);
            background-size: 80px 80px;
            opacity: 0.6;
            z-index: 0;
        }

        .glass {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            backdrop-filter: blur(18px);
            box-shadow: 0 24px 60px rgba(2, 6, 23, 0.35);
        }

        .cta-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #ff7a00 100%);
            color: #0a0a0a;
            border: none;
        }

        .cta-secondary {
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-strong);
            background: rgba(15, 23, 42, 0.5);
        }

        .field {
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: var(--text-strong);
        }

        .badge {
            padding: 0.3rem 0.85rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .badge-ok { background: rgba(68, 255, 143, 0.16); color: var(--success); border: 1px solid rgba(68, 255, 143, 0.4); }
        .badge-warning { background: rgba(255, 209, 102, 0.16); color: var(--warning); border: 1px solid rgba(255, 209, 102, 0.45); }
        .badge-ng { background: rgba(255, 107, 107, 0.16); color: var(--danger); border: 1px solid rgba(255, 107, 107, 0.45); }
        .badge-retake { background: rgba(124, 124, 255, 0.16); color: var(--retake); border: 1px solid rgba(124, 124, 255, 0.45); }

        .table-row:hover { background: rgba(148, 163, 184, 0.08); }
    </style>
</head>
<body class="min-h-screen">
    <div class="grid-overlay"></div>
    <div class="relative z-10">
        <header class="max-w-7xl mx-auto px-6 py-6">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div class="flex items-center gap-4">
                    <div class="h-12 w-12 rounded-2xl bg-gradient-to-br from-orange-400 to-amber-500 flex items-center justify-center text-black text-xl font-bold">CM</div>
                    <div>
                        <p class="mono text-xs text-slate-400">INSPECTION HISTORY</p>
                        <h1 class="text-3xl">검사 히스토리 트래킹</h1>
                    </div>
                </div>
                <nav class="flex flex-wrap gap-3 text-sm">
                    <a href="/" class="cta-secondary px-4 py-2 rounded-full">Overview</a>
                    <a href="/stats" class="cta-secondary px-4 py-2 rounded-full">통계</a>
                    <a href="/v7" class="cta-secondary px-4 py-2 rounded-full">V7</a>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 pb-16 space-y-8">
            <section class="glass rounded-3xl p-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div>
                        <p class="mono text-xs text-slate-400">SUMMARY SIGNALS</p>
                        <h2 class="text-2xl">최근 검사 요약</h2>
                    </div>
                    <div class="text-sm text-slate-400">기간/필터 기준으로 자동 갱신</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                    <div class="glass rounded-2xl p-4">
                        <p class="text-xs text-slate-400">Total Inspections</p>
                        <p class="text-3xl font-semibold mt-1 mono" id="stat-total">-</p>
                    </div>
                    <div class="glass rounded-2xl p-4">
                        <p class="text-xs text-slate-400">Pass Rate</p>
                        <p class="text-3xl font-semibold mt-1 text-emerald-300" id="stat-pass-rate">-</p>
                    </div>
                    <div class="glass rounded-2xl p-4">
                        <p class="text-xs text-slate-400">Avg Delta E</p>
                        <p class="text-3xl font-semibold mt-1" id="stat-avg-delta-e">-</p>
                    </div>
                    <div class="glass rounded-2xl p-4">
                        <p class="text-xs text-slate-400">Avg Confidence</p>
                        <p class="text-3xl font-semibold mt-1" id="stat-avg-confidence">-</p>
                    </div>
                </div>
            </section>

            <section class="glass rounded-3xl p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="mono text-xs text-slate-400">FILTERS</p>
                        <h2 class="text-2xl">필터로 기록을 좁혀보기</h2>
                    </div>
                    <div class="text-xs text-slate-500">필터 적용 시 통계와 표가 동시에 업데이트됩니다.</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div>
                        <label class="text-xs text-slate-400">SKU Code</label>
                        <input type="text" id="filter-sku" placeholder="SKU001" class="field mt-2 w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Operator</label>
                        <input type="text" id="filter-operator" placeholder="Operator" class="field mt-2 w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Batch</label>
                        <input type="text" id="filter-batch" placeholder="Batch/Lot" class="field mt-2 w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Judgment</label>
                        <select id="filter-judgment" class="field mt-2 w-full px-3 py-2 rounded-lg">
                            <option value="">All</option>
                            <option value="OK">OK</option>
                            <option value="OK_WITH_WARNING">OK with Warning</option>
                            <option value="NG">NG</option>
                            <option value="RETAKE">RETAKE</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400">Start</label>
                            <input type="date" id="filter-start" class="field mt-2 w-full px-2 py-2 rounded-lg">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">End</label>
                            <input type="date" id="filter-end" class="field mt-2 w-full px-2 py-2 rounded-lg">
                        </div>
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="applyFilters()" class="cta-primary w-full px-4 py-2 rounded-lg font-semibold">
                            <i class="fas fa-filter mr-2"></i>Apply
                        </button>
                        <button onclick="exportCsv()" class="cta-secondary w-full px-4 py-2 rounded-lg">
                            <i class="fas fa-file-export mr-2"></i>CSV
                        </button>
                    </div>
                </div>
            </section>

            <section class="glass rounded-3xl p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                    <div>
                        <p class="mono text-xs text-slate-400">INSPECTION TABLE</p>
                        <h2 class="text-2xl">검사 기록</h2>
                    </div>
                    <div class="text-sm text-slate-400">
                        Showing <span id="showing-count">0</span> of <span id="total-count">0</span> records
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-xs text-slate-400 uppercase border-b border-slate-800">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">Date/Time</th>
                                <th class="px-4 py-3">SKU</th>
                                <th class="px-4 py-3">Image</th>
                                <th class="px-4 py-3">Operator</th>
                                <th class="px-4 py-3">Batch</th>
                                <th class="px-4 py-3">Judgment</th>
                                <th class="px-4 py-3">ΔE</th>
                                <th class="px-4 py-3">Confidence</th>
                                <th class="px-4 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>

                <div class="mt-4 flex items-center justify-between">
                    <button id="btn-prev" onclick="previousPage()" class="cta-secondary px-4 py-2 rounded-lg">
                        <i class="fas fa-chevron-left mr-2"></i>Previous
                    </button>
                    <div class="text-sm text-slate-400">Page <span id="current-page">1</span></div>
                    <button id="btn-next" onclick="nextPage()" class="cta-secondary px-4 py-2 rounded-lg">
                        Next<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </section>
        </main>

        <div id="detail-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 border-b border-slate-800 px-6 py-4 flex items-center justify-between">
                    <h3 class="text-xl">Inspection Details</h3>
                    <button onclick="closeDetailModal()" class="text-slate-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="detail-content" class="p-6"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalRecords = 0;
        const pageSize = 20;
        const HISTORY_FILTERS_KEY = 'cm_history_filters_v1';

        const FILTER_IDS = [
            'filter-sku',
            'filter-operator',
            'filter-batch',
            'filter-judgment',
            'filter-start',
            'filter-end'
        ];

        const debounce = (fn, delay = 350) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        };

        function getFilterValues() {
            return {
                sku: document.getElementById('filter-sku').value,
                operator: document.getElementById('filter-operator').value,
                batch: document.getElementById('filter-batch').value,
                judgment: document.getElementById('filter-judgment').value,
                start: document.getElementById('filter-start').value,
                end: document.getElementById('filter-end').value
            };
        }

        function setFilterValues(filters) {
            if (!filters) return;
            document.getElementById('filter-sku').value = filters.sku || '';
            document.getElementById('filter-operator').value = filters.operator || '';
            document.getElementById('filter-batch').value = filters.batch || '';
            document.getElementById('filter-judgment').value = filters.judgment || '';
            document.getElementById('filter-start').value = filters.start || '';
            document.getElementById('filter-end').value = filters.end || '';
        }

        function saveFilters() {
            try {
                localStorage.setItem(HISTORY_FILTERS_KEY, JSON.stringify(getFilterValues()));
            } catch (error) {
                console.warn('Failed to save filters:', error);
            }
        }

        function loadSavedFilters() {
            try {
                const saved = localStorage.getItem(HISTORY_FILTERS_KEY);
                if (saved) setFilterValues(JSON.parse(saved));
            } catch (error) {
                console.warn('Failed to load saved filters:', error);
            }
        }

        function setupAutoApply() {
            const autoApply = debounce(() => {
                currentPage = 1;
                applyFilters();
            });

            FILTER_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const eventName = (el.tagName === 'SELECT' || el.type === 'date') ? 'change' : 'input';
                el.addEventListener(eventName, autoApply);
                if (eventName === 'change') {
                    el.addEventListener('input', autoApply);
                }
            });
        }

        function getDateRangeParams() {
            const startVal = document.getElementById('filter-start').value;
            const endVal = document.getElementById('filter-end').value;

            const params = new URLSearchParams();
            if (startVal) {
                params.append('start_date', `${startVal}T00:00:00Z`);
            }
            if (endVal) {
                params.append('end_date', `${endVal}T23:59:59Z`);
            }
            if (!startVal && !endVal) {
                params.append('days', '30');
            }
            return params;
        }

        async function loadStats() {
            try {
                const sku = document.getElementById('filter-sku').value || null;
                const params = getDateRangeParams();
                if (sku) params.append('sku_code', sku);

                const response = await fetch(`/api/inspection/history/stats/summary?${params}`);
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.total_inspections.toLocaleString();
                document.getElementById('stat-pass-rate').textContent = (data.pass_rate * 100).toFixed(1) + '%';
                document.getElementById('stat-avg-delta-e').textContent = data.avg_delta_e.toFixed(2);
                document.getElementById('stat-avg-confidence').textContent = (data.avg_confidence * 100).toFixed(1) + '%';
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadHistory() {
            try {
                const skip = (currentPage - 1) * pageSize;
                const params = new URLSearchParams({
                    skip: skip,
                    limit: pageSize
                });

                const sku = document.getElementById('filter-sku').value;
                const operator = document.getElementById('filter-operator').value;
                const batch = document.getElementById('filter-batch').value;
                const judgment = document.getElementById('filter-judgment').value;

                if (sku) params.append('sku_code', sku);
                if (operator) params.append('operator', operator);
                if (batch) params.append('batch_number', batch);
                if (judgment) params.append('judgment', judgment);

                const dateParams = getDateRangeParams();
                dateParams.forEach((value, key) => params.append(key, value));

                const response = await fetch(`/api/inspection/history?${params}`);
                const data = await response.json();

                totalRecords = data.total;
                renderTable(data.results);
                updatePagination();

                document.getElementById('showing-count').textContent = data.results.length;
                document.getElementById('total-count').textContent = data.total;
            } catch (error) {
                console.error('Failed to load history:', error);
                document.getElementById('history-table-body').innerHTML =
                    '<tr><td colspan="10" class="px-4 py-8 text-center text-slate-400">Failed to load data</td></tr>';
            }
        }

        function renderTable(results) {
            const tbody = document.getElementById('history-table-body');

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-8 text-center text-slate-400">No records found</td></tr>';
                return;
            }

            tbody.innerHTML = results.map(row => {
                const date = new Date(row.created_at);
                const dateStr = date.toLocaleDateString('ko-KR');
                const timeStr = date.toLocaleTimeString('ko-KR');

                let badgeClass = 'badge-retake';
                if (row.judgment === 'OK') badgeClass = 'badge-ok';
                else if (row.judgment === 'OK_WITH_WARNING') badgeClass = 'badge-warning';
                else if (row.judgment === 'NG') badgeClass = 'badge-ng';

                return `
                    <tr class="table-row">
                        <td class="px-4 py-3 text-slate-200">#${row.id}</td>
                        <td class="px-4 py-3 text-slate-400">
                            <div>${dateStr}</div>
                            <div class="text-xs text-slate-500">${timeStr}</div>
                        </td>
                        <td class="px-4 py-3 font-semibold text-slate-200">${row.sku_code}</td>
                        <td class="px-4 py-3 text-slate-400 max-w-xs truncate" title="${row.image_filename}">
                            ${row.image_filename}
                        </td>
                        <td class="px-4 py-3 text-slate-400">${row.operator || '-'}</td>
                        <td class="px-4 py-3 text-slate-400">${row.batch_number || '-'}</td>
                        <td class="px-4 py-3">
                            <span class="badge ${badgeClass}">${row.judgment}</span>
                        </td>
                        <td class="px-4 py-3 text-slate-200">${row.overall_delta_e.toFixed(2)}</td>
                        <td class="px-4 py-3 text-slate-200">${(row.confidence * 100).toFixed(1)}%</td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="viewDetail('${row.session_id}')"
                                    class="text-orange-300 hover:text-orange-200 font-medium">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = currentPage >= totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadHistory();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                loadHistory();
            }
        }

        function applyFilters() {
            currentPage = 1;
            saveFilters();
            loadStats();
            loadHistory();
        }

        function exportCsv() {
            const params = new URLSearchParams();
            const sku = document.getElementById('filter-sku').value;
            const operator = document.getElementById('filter-operator').value;
            const batch = document.getElementById('filter-batch').value;
            const judgment = document.getElementById('filter-judgment').value;

            if (sku) params.append('sku_code', sku);
            if (operator) params.append('operator', operator);
            if (batch) params.append('batch_number', batch);
            if (judgment) params.append('judgment', judgment);

            const dateParams = getDateRangeParams();
            dateParams.forEach((value, key) => params.append(key, value));

            window.location.href = `/api/inspection/history/export?${params.toString()}`;
        }

        async function viewDetail(sessionId) {
            try {
                const response = await fetch(`/api/inspection/history/session/${sessionId}?include_full_result=true`);
                const data = await response.json();

                const modal = document.getElementById('detail-modal');
                const content = document.getElementById('detail-content');

                let ngReasonsHtml = '';
                if (data.ng_reasons && data.ng_reasons.length > 0) {
                    ngReasonsHtml = `
                        <div class="mb-4">
                            <h4 class="font-semibold text-slate-200 mb-2">NG Reasons</h4>
                            <ul class="list-disc list-inside text-slate-400">
                                ${data.ng_reasons.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                let nextActionsHtml = '';
                if (data.next_actions && data.next_actions.length > 0) {
                    nextActionsHtml = `
                        <div class="mb-4">
                            <h4 class="font-semibold text-slate-200 mb-2">Next Actions</h4>
                            <ul class="list-disc list-inside text-slate-400">
                                ${data.next_actions.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-slate-500">Session ID</p>
                                <p class="font-medium text-slate-200">${data.session_id}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">SKU</p>
                                <p class="font-medium text-slate-200">${data.sku_code}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Operator</p>
                                <p class="font-medium text-slate-200">${data.operator || '-'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Batch</p>
                                <p class="font-medium text-slate-200">${data.batch_number || '-'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Judgment</p>
                                <p class="font-medium text-slate-200">${data.judgment}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Delta E</p>
                                <p class="font-medium text-slate-200">${data.overall_delta_e.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Confidence</p>
                                <p class="font-medium text-slate-200">${(data.confidence * 100).toFixed(1)}%</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Zones</p>
                                <p class="font-medium text-slate-200">${data.zones_count}</p>
                            </div>
                        </div>

                        ${ngReasonsHtml}
                        ${nextActionsHtml}

                        <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Full Analysis Result</h4>
                            <pre class="bg-slate-900/80 p-4 rounded-lg text-xs overflow-x-auto text-slate-300">${JSON.stringify(data.analysis_result, null, 2)}</pre>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load detail:', error);
                alert('Failed to load inspection details');
            }
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        window.addEventListener('load', () => {
            loadSavedFilters();
            setupAutoApply();
            applyFilters();
        });
    </script>
</body>
</html>
