<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Meter Analysis Dashboard</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; }
        .sidebar { height: 100vh; position: fixed; top: 0; left: 0; padding-top: 60px; background-color: #ffffff; border-right: 1px solid #dee2e6; z-index: 1000; }
        .main-content { margin-left: 280px; padding: 20px; padding-top: 80px; }
        .viewer-container { position: relative; width: 100%; height: 500px; background-color: #333; display: flex; justify-content: center; align-items: center; overflow: hidden; border-radius: 8px; }
        #sourceImage { max-height: 100%; max-width: 100%; display: block; }
        #overlayCanvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        .nav-link.active { font-weight: bold; border-bottom: 2px solid #0d6efd; }
        .card-header { font-weight: 600; background-color: #fff; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Spinner overlay */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 fw-bold">Analyzing...</p>
        </div>
    </div>

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-bullseye"></i> Color Meter <span class="badge bg-info text-dark">Analysis Mode</span>
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar: Controls -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Input Source</span>
                    </h6>
                    <div class="px-3 mb-3">
                        <label for="uploadImage" class="form-label text-small">Image File</label>
                        <input class="form-control form-control-sm" type="file" id="uploadImage" accept="image/*">
                    </div>
                    <div class="px-3 mb-3">
                        <label for="skuSelect" class="form-label text-small">Target SKU</label>
                        <select class="form-select form-select-sm" id="skuSelect">
                            <option value="SKU001" selected>SKU001 (Default)</option>
                            <option value="SKU002">SKU002</option>
                        </select>
                    </div>

                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Analysis Parameters</span>
                    </h6>
                    <div class="px-3 mb-3">
                        <label for="smoothingWindow" class="form-label text-small">Smoothing Window: <span id="swVal">5</span></label>
                        <input type="range" class="form-range" min="3" max="21" step="2" value="5" id="smoothingWindow">
                    </div>
                    <div class="px-3 mb-3">
                        <label for="gradThreshold" class="form-label text-small">Gradient Threshold: <span id="gtVal">0.5</span></label>
                        <input type="range" class="form-range" min="0.1" max="5.0" step="0.1" value="0.5" id="gradThreshold">
                    </div>

                    <div class="d-grid gap-2 px-3 mt-4">
                        <button class="btn btn-primary btn-sm" id="btnAnalyze">
                            <i class="bi bi-play-fill"></i> Run Analysis
                        </button>
                    </div>

                    <hr>
                    <div class="px-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="chkShowOverlay" checked>
                            <label class="form-check-label" for="chkShowOverlay">Show Overlay</label>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">

                <!-- Viewer Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-image"></i> Interactive Viewer</span>
                                <span class="badge bg-secondary" id="imgDims">- x -</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="viewer-container" id="viewerContainer">
                                    <!-- Image and Canvas will be injected here -->
                                    <p class="text-white-50" id="placeholderText">Please upload an image to start.</p>
                                    <img id="sourceImage" style="display:none;" />
                                    <canvas id="overlayCanvas"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results Section -->
                <div class="row">
                    <!-- Tabs -->
                    <div class="col-12 mb-3">
                        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-pane" type="button" role="tab">Radial Profile</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="gradient-tab" data-bs-toggle="tab" data-bs-target="#gradient-pane" type="button" role="tab">Gradients</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="candidates-tab" data-bs-toggle="tab" data-bs-target="#candidates-pane" type="button" role="tab">Boundary Candidates</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-pane" type="button" role="tab">Raw Data</button>
                            </li>
                        </ul>
                    </div>

                    <div class="col-12">
                        <div class="tab-content" id="resultTabsContent">
                            <!-- Tab 1: Radial Profile -->
                            <div class="tab-pane fade show active" id="profile-pane" role="tabpanel">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="profileChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 2: Gradients -->
                            <div class="tab-pane fade" id="gradient-pane" role="tabpanel">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="gradientChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 3: Candidates Table -->
                            <div class="tab-pane fade" id="candidates-pane" role="tabpanel">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <table class="table table-hover table-sm" id="candidatesTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Method</th>
                                                    <th>Radius (norm)</th>
                                                    <th>Value</th>
                                                    <th>Confidence</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Rows injected by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 4: Raw JSON -->
                            <div class="tab-pane fade" id="json-pane" role="tabpanel">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-end mb-2 gap-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="downloadJson()"><i class="bi bi-download"></i> Download .json</button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="copyRawJson()"><i class="bi bi-clipboard"></i> Copy JSON</button>
                                        </div>
                                        <pre id="rawJsonViewer" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.85em;"></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Log Console Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card shadow-sm border-secondary">
                            <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                                <span class="small fw-bold"><i class="bi bi-terminal"></i> System Logs</span>
                                <button class="btn btn-xs btn-outline-secondary py-0" style="font-size: 0.75rem;" onclick="clearLogs()">Clear</button>
                            </div>
                            <div class="card-body p-0">
                                <div id="logConsole" style="height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; padding: 10px; background-color: #1e1e1e; color: #00ff00;">
                                    <div class="text-muted">> System ready.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- Global State ---
        let currentImageFile = null;
        let analysisData = null;
        const viewerContainer = document.getElementById('viewerContainer');
        const imgElement = document.getElementById('sourceImage');
        const canvas = document.getElementById('overlayCanvas');
        const ctx = canvas.getContext('2d');
        const logConsole = document.getElementById('logConsole');

        let profileChart = null;
        let gradientChart = null;

        // --- Logging Function ---
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.marginBottom = '2px';
            if (type === 'error') div.style.color = '#ff4444';
            else if (type === 'success') div.style.color = '#00cc00';
            else div.style.color = '#cccccc';

            div.innerHTML = `<span style="opacity:0.5">[${now}]</span> ${message}`;
            logConsole.appendChild(div);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function clearLogs() {
            logConsole.innerHTML = '<div class="text-muted">> Logs cleared.</div>';
        }

        // --- Event Listeners ---
        document.getElementById('smoothingWindow').addEventListener('input', (e) => document.getElementById('swVal').textContent = e.target.value);
        document.getElementById('gradThreshold').addEventListener('input', (e) => document.getElementById('gtVal').textContent = e.target.value);

        document.getElementById('uploadImage').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                currentImageFile = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imgElement.src = evt.target.result;
                    imgElement.style.display = 'block';
                    document.getElementById('placeholderText').style.display = 'none';
                    log("Image loaded locally: " + currentImageFile.name);

                    // Resize canvas to match image when loaded
                    imgElement.onload = () => {
                        canvas.width = imgElement.width;
                        canvas.height = imgElement.height;
                        canvas.style.width = imgElement.clientWidth + 'px';
                        canvas.style.height = imgElement.clientHeight + 'px';
                        document.getElementById('imgDims').textContent = `${imgElement.naturalWidth} x ${imgElement.naturalHeight}`;
                        clearOverlay();
                    };
                };
                reader.readAsDataURL(currentImageFile);
            }
        });

        document.getElementById('btnAnalyze').addEventListener('click', runAnalysis);

        // --- Functions ---

        async function runAnalysis() {
            if (!currentImageFile) {
                log("Error: No image selected.", 'error');
                return;
            }

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            log("Starting analysis...", 'info');

            const formData = new FormData();
            formData.append('file', currentImageFile);
            formData.append('sku', document.getElementById('skuSelect').value);
            formData.append('smoothing_window', document.getElementById('smoothingWindow').value);
            formData.append('gradient_threshold', document.getElementById('gradThreshold').value);
            formData.append('run_judgment', 'false');

            try {
                const response = await fetch('/inspect_v2', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                analysisData = await response.json();
                log("Analysis successful!", 'success');
                console.log("Analysis Result:", analysisData);

                updateCharts(analysisData);
                updateCandidatesTable(analysisData.analysis.boundary_candidates);
                drawOverlay(analysisData);

                // Update Raw JSON view
                document.getElementById('rawJsonViewer').textContent = JSON.stringify(analysisData, null, 2);

            } catch (error) {
                console.error(error);
                log("Analysis failed: " + error.message, 'error');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function updateCharts(data) {
            const profile = data.analysis.profile;
            const derivs = data.analysis.derivatives;
            const radius = profile.radius; // x-axis

            // 1. Profile Chart
            if (profileChart) profileChart.destroy();
            const ctx1 = document.getElementById('profileChart').getContext('2d');
            profileChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: radius.map(r => r.toFixed(3)),
                    datasets: [
                        { label: 'L* (Smooth)', data: profile.L_smoothed, borderColor: 'rgb(255, 99, 132)', tension: 0.1, borderWidth: 2 },
                        { label: 'L* (Raw)', data: profile.L_raw, borderColor: 'rgba(255, 99, 132, 0.2)', borderWidth: 1, pointRadius: 0 },
                        { label: 'a* (Smooth)', data: profile.a_smoothed, borderColor: 'rgb(54, 162, 235)', tension: 0.1, borderWidth: 2 },
                        { label: 'b* (Smooth)', data: profile.b_smoothed, borderColor: 'rgb(255, 206, 86)', tension: 0.1, borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { title: { display: true, text: 'Normalized Radius' } },
                        y: { title: { display: true, text: 'Value' } }
                    }
                }
            });

            // 2. Gradient Chart
            if (gradientChart) gradientChart.destroy();
            const ctx2 = document.getElementById('gradientChart').getContext('2d');
            gradientChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: radius.map(r => r.toFixed(3)),
                    datasets: [
                        { label: 'Grad Magnitude', data: derivs.gradient_magnitude, borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.1)' },
                        { label: '2nd Deriv L', data: derivs.second_derivative_L, borderColor: 'rgba(153, 102, 255, 0.6)', borderWidth: 1, borderDash: [5, 5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
            });
        }

        function updateCandidatesTable(candidates) {
            const tbody = document.querySelector('#candidatesTable tbody');
            tbody.innerHTML = '';

            if (!candidates || candidates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No candidates detected</td></tr>';
                return;
            }

            candidates.forEach((c, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="badge bg-secondary">${c.method}</span></td>
                    <td>${c.radius.toFixed(3)}</td>
                    <td>${c.value.toFixed(3)}</td>
                    <td>${c.confidence ? c.confidence.toFixed(2) : '-'}</td>
                    <td><button class="btn btn-sm btn-outline-primary py-0" onclick="highlightBoundary(${index})">Show</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function copyRawJson() {
            const text = document.getElementById('rawJsonViewer').textContent;
            navigator.clipboard.writeText(text).then(() => {
                log("JSON copied to clipboard!", 'success');
            }, (err) => {
                log("Failed to copy JSON: " + err, 'error');
            });
        }

        function downloadJson() {
            if (!analysisData) {
                log("No analysis data to download.", 'error');
                return;
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(analysisData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);

            // Filename: analysis_runID.json
            const filename = `analysis_${analysisData.run_id || 'result'}.json`;
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            log(`JSON file downloaded: ${filename}`, 'success');
        }

        function clearOverlay() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function drawOverlay(data) {
            if (!document.getElementById('chkShowOverlay').checked) return;
            clearOverlay();

            // Draw Center
            // Assuming center is not returned in this simplified JSON, but normally it should be.
            // For now, we will rely on the server returning an overlay IMAGE or coordinates.
            // In Phase 1, we might just have normalized radius.
            // To draw normalized radius circles, we need the detected Lens Radius in pixels.

            // *NOTE*: The server should return 'lens_info' (center_x, center_y, radius_px).
            if (data.analysis.lens_info) {
                const { center_x, center_y, radius_px } = data.analysis.lens_info;

                // Draw Lens Boundary
                ctx.beginPath();
                ctx.arc(center_x, center_y, radius_px, 0, 2 * Math.PI);
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw Candidates
                data.analysis.boundary_candidates.forEach(c => {
                    const r_px = c.radius * radius_px; // norm * pixel_radius
                    ctx.beginPath();
                    ctx.arc(center_x, center_y, r_px, 0, 2 * Math.PI);
                    ctx.strokeStyle = 'rgba(0, 255, 0, 0.7)'; // Green
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                });
            }
        }

        window.highlightBoundary = function(index) {
            // Highlight specific boundary (Red)
            if (!analysisData || !analysisData.analysis.lens_info) return;

            // Redraw all first
            drawOverlay(analysisData);

            const c = analysisData.analysis.boundary_candidates[index];
            const { center_x, center_y, radius_px } = analysisData.analysis.lens_info;
            const r_px = c.radius * radius_px;

            ctx.beginPath();
            ctx.arc(center_x, center_y, r_px, 0, 2 * Math.PI);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.stroke();
        };

        document.getElementById('chkShowOverlay').addEventListener('change', () => {
             if(analysisData) drawOverlay(analysisData);
             else clearOverlay();
        });

    </script>
</body>
</html>
